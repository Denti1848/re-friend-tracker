import * as tslib_1 from "tslib";
import { Component, Input, Output, ViewChild } from "@angular/core";
import { ValueField } from "../value-field";
import { HttpClient, HttpEvent, HttpEventType, HttpParams, HttpRequest, HttpResponse } from "@angular/common/http";
let FileUploadComponent = class FileUploadComponent {
    constructor(http) {
        this.http = http;
        this.dragActive = false;
    }
    onDropFile(event) {
        this.dragActive = false;
        event.preventDefault();
        this.uploadFile(event.dataTransfer.files);
    }
    onDragOverFile(event) {
        this.dragActive = true;
        event.stopPropagation();
        event.preventDefault();
    }
    onDragLeave() {
        this.dragActive = false;
    }
    selectFile(event) {
        this.uploadFile(event.target.files);
    }
    uploadFile(files) {
        if (files.length === 0) {
            console.log("No file selected!");
            return;
        }
        // check if file limit is exceeded
        if (!this.field.checkFileLimit(files.length)) {
            this.resetFileUploadElement();
            return;
        }
        // check file sizes
        if (!this.field.checkFileSize(files)) {
            this.resetFileUploadElement();
            return;
        }
        // upload submitted files
        Array.from(files).forEach((file) => {
            this.doUpload(this.field.getForm().getApp().getBackendUrl() + this.field.url, file)
                .subscribe(event => {
                if (event.type === HttpEventType.UploadProgress) {
                    const percentDone = Math.round(100 * event.loaded / event.total);
                    let uploadFile = this.field.findCurrentUpload(file.name);
                    if (uploadFile == null) {
                        uploadFile = this.addNewPathFile(file);
                    }
                    uploadFile.uploadProgress = percentDone;
                }
                else if (event instanceof HttpResponse) {
                    let uploadFile = this.field.findCurrentUpload(file.name);
                    if (uploadFile == null) {
                        uploadFile = this.addNewPathFile(file);
                    }
                    const key = new PathFileKey(event.body["key"]["key"], event.body["key"]["name"]);
                    uploadFile.key = key;
                    uploadFile.uploadFinished = true;
                    uploadFile.uploadSuccessful = true;
                    this.field.updateRequiredStatus();
                }
            }, (err) => {
                console.log("Upload Error:", err);
                const uploadFile = this.field.findCurrentUpload(file.name);
                if (uploadFile) {
                    uploadFile.sizeString = "Error";
                    uploadFile.uploadFinished = true;
                }
                else {
                    console.log("error: file should exist (" + file.name + ")");
                }
                this.resetFileUploadElement();
            }, () => {
                this.resetFileUploadElement();
            });
        });
    }
    addNewPathFile(file) {
        const uploadFile = new PathFile();
        uploadFile.name = file.name;
        uploadFile.size = file.size;
        uploadFile.sizeString = this.field.getReadableFileSizeString(file.size);
        uploadFile.active = true;
        this.field.value.push(uploadFile);
        this.field.sortValues();
        return uploadFile;
    }
    resetFileUploadElement() {
        const count = this.field.value.reduce((acc, cur) => !cur.uploadFinished ? ++acc : acc, 0);
        if (count === 0) {
            this.fileInputReference.nativeElement.value = "";
        }
    }
    doUpload(url, file) {
        const formData = new FormData();
        formData.append("upload", file);
        const params = new HttpParams();
        const options = {
            params: params,
            reportProgress: true,
        };
        const req = new HttpRequest("POST", url, formData, options);
        return this.http.request(req); // <any> fixes TS2719
    }
};
FileUploadComponent.ctorParameters = () => [
    { type: HttpClient }
];
tslib_1.__decorate([
    Input("field"),
    Output("field")
], FileUploadComponent.prototype, "field", void 0);
tslib_1.__decorate([
    ViewChild("fileInput", { static: true })
], FileUploadComponent.prototype, "fileInputReference", void 0);
FileUploadComponent = tslib_1.__decorate([
    Component({
        selector: "path-file-upload",
        template: "<path-form-field-label [label]=\"field.name\" [required]=\"field.required\"></path-form-field-label>\r\n<div [class.col-md-4]=\"field.width == 1\" [class.col-md-10]=\"field.width == 2\" [class.file-upload-drop]=\"dragActive\"\r\n     (drop)=\"onDropFile($event)\" (dragleave)=\"onDragLeave()\" (dragover)=\"onDragOverFile($event)\">\r\n    <table class=\"table\">\r\n        <thead>\r\n        <tr>\r\n            <td class=\"col-md-7\">File Name</td>\r\n            <td class=\"col-md-2\">Size</td>\r\n            <td class=\"col-md-3\"></td>\r\n        </tr>\r\n        </thead>\r\n        <tbody>\r\n        <ng-container *ngFor=\"let file of field.value; let index = index\">\r\n            <tr *ngIf=\"file.active\">\r\n                <td class=\"col-md-7\"><a href=\"#\" (click)=\"field.download(file.key)\">{{file.name}}</a></td>\r\n                <td class=\"col-md-2\">{{file.sizeString}}</td>\r\n                <td class=\"col-md-3\" align=\"right\">\r\n                    <a *ngIf=\"file.uploadFinished\" href=\"#\" (click)=\"field.remove(index, file.key)\">Remove</a>\r\n                    <div *ngIf=\"!file.uploadFinished\" class=\"progress\">\r\n                        <div class=\"progress-bar\" role=\"progressbar\" [style.width.%]=\"file.uploadProgress\"\r\n                             [attr.aria-valuenow]=\"file.uploadProgress\" aria-valuemin=\"0\" aria-valuemax=\"100\">\r\n                            <span class=\"sr-only\">{{file.uploadProgress}}% Complete</span>\r\n                        </div>\r\n                    </div>\r\n                </td>\r\n            </tr>\r\n        </ng-container>\r\n        </tbody>\r\n    </table>\r\n    <div class=\"form-group\">\r\n        <input type=\"file\" class=\"form-control-file\" (change)=\"selectFile($event)\" placeholder=\"Upload file\"\r\n               [multiple]=\"field.multiple\" accept=\"{{field.acceptedFileTypes.join(', ')}}\"\r\n               [disabled]=\"field.isReadonly()\"\r\n               [required]=\"field.fileUploadRequired\" #fileInput>\r\n    </div>\r\n</div>\r\n"
    })
], FileUploadComponent);
export { FileUploadComponent };
export class FileUploadField extends ValueField {
    constructor(form, translationService) {
        super(form, translationService);
        this._multiple = true;
        this._acceptedFileTypes = [];
        this._fileLimit = 0;
        this._singleFileSizeLimit = 0;
        this._allFilesSizeLimit = 0;
        this.value = [];
        this._acceptedFileTypes.push("*.*");
        this.updateRequiredStatus();
    }
    setValue(value) {
        const files = [];
        for (const item of value) {
            const file = Object.assign(new PathFile(), item);
            file.key = Object.assign(new PathFileKey(null, null), item.key);
            files.push(file);
        }
        this.sortValues();
        super.setValue(files);
        this.updateRequiredStatus();
    }
    sortValues() {
        this.value.sort((a, b) => a.name.localeCompare(b.name));
    }
    get url() {
        return this._url;
    }
    set url(value) {
        this._url = value;
    }
    get multiple() {
        return this._multiple;
    }
    set multiple(value) {
        this._multiple = value;
    }
    get acceptedFileTypes() {
        return this._acceptedFileTypes;
    }
    set acceptedFileTypes(value) {
        this._acceptedFileTypes = value;
    }
    get fileUploadRequired() {
        return this._fileUploadRequired;
    }
    get fileLimit() {
        return this._fileLimit;
    }
    get singleFileSizeLimit() {
        return this._singleFileSizeLimit;
    }
    get allFilesSizeLimit() {
        return this._allFilesSizeLimit;
    }
    remove(index, key) {
        if (key) {
            const file = this.find(key);
            if (file) {
                file.active = false;
            }
            this.updateRequiredStatus();
        }
        else {
            this.value.splice(index, 1);
        }
    }
    find(key) {
        for (const file of this.value) {
            if (file.key.equals(key)) {
                return file;
            }
        }
        return null;
    }
    findCurrentUpload(name) {
        for (const file of this.value) {
            if (file.name === name && !file.uploadFinished) {
                return file;
            }
        }
        return null;
    }
    updateRequiredStatus() {
        let uploadInProgressCount = 0;
        let uploadSuccessfulCount = 0;
        this.value.forEach((file) => {
            if (file.active && !file.uploadFinished) {
                uploadInProgressCount++;
            }
            if (file.active && file.uploadSuccessful) {
                uploadSuccessfulCount++;
            }
        });
        let newStatus = false;
        if (uploadInProgressCount > 0) {
            // always required if upload in progress
            newStatus = true;
        }
        else if (this.required && uploadSuccessfulCount <= 0) {
            newStatus = true;
        }
        this._fileUploadRequired = newStatus;
    }
    checkFileLimit(newFilesLength) {
        let activeFileCount = 0;
        this.value.forEach((file) => {
            if (file.active) {
                activeFileCount++;
            }
        });
        if (this.fileLimit > 0 && ((activeFileCount + newFilesLength) > this.fileLimit)) {
            const message = this.translationService.getText("FileLimitMessage", String(this.fileLimit));
            this.getForm().getApp().yesNo(message, () => { }, () => { });
            return false;
        }
        return true;
    }
    checkFileSize(files) {
        if (this._singleFileSizeLimit || this._allFilesSizeLimit) {
            // check single file limit
            let sizeSum = 0;
            const fileArray = Array.from(files);
            for (const file of fileArray) {
                sizeSum += file.size;
                if (this._singleFileSizeLimit > 0 && file.size > this._singleFileSizeLimit) {
                    const message = this.translationService.getText("FileSingleSizeMessage", this.getReadableFileSizeString(this._singleFileSizeLimit));
                    this.getForm().getApp().yesNo(message, () => { }, () => { });
                    return false;
                }
            }
            // check sum limit
            if (this._allFilesSizeLimit > 0) {
                this.value.forEach((file) => {
                    if (file.active) {
                        sizeSum += file.size;
                    }
                });
                if (this._allFilesSizeLimit > 0 && sizeSum > this._allFilesSizeLimit) {
                    const message = this.translationService.getText("FileAllSizeMessage", this.getReadableFileSizeString(this._allFilesSizeLimit));
                    this.getForm().getApp().yesNo(message, () => { }, () => { });
                    return false;
                }
            }
        }
        return true;
    }
    getReadableFileSizeString(byteSize) {
        let i = -1;
        const byteUnits = [" kB", " MB", " GB", " TB", " PB", " EB", " ZB", " YB"];
        do {
            byteSize = byteSize / 1024;
            i++;
        } while (byteSize > 1024);
        return Math.max(byteSize, 0.1).toFixed(1) + byteUnits[i];
    }
    download(key) {
        window.location.assign(this.getForm().getApp().getBackendUrl() + this.url + "/" + key.key);
    }
    fromJson(modelFormField) {
        super.fromJson(modelFormField);
        this.type = "fileUpload";
        if (modelFormField["url"]) {
            this.url = modelFormField["url"];
        }
        if (modelFormField["multiple"] != null) {
            this.multiple = modelFormField["multiple"];
        }
        if (modelFormField["acceptedFileTypes"]) {
            this.acceptedFileTypes = modelFormField["acceptedFileTypes"];
        }
        if (modelFormField["fileLimit"]) {
            this._fileLimit = modelFormField["fileLimit"];
        }
        if (modelFormField["singleFileSizeLimit"]) {
            this._singleFileSizeLimit = modelFormField["singleFileSizeLimit"];
        }
        if (modelFormField["allFilesSizeLimit"]) {
            this._allFilesSizeLimit = modelFormField["allFilesSizeLimit"];
        }
        this.updateRequiredStatus();
    }
}
export class PathFile {
    constructor() {
        this.uploadFinished = false;
        this.uploadSuccessful = false;
        this.uploadProgress = 0;
        this.size = 0;
    }
}
// TODO unify with list key
// tslint:disable:max-classes-per-file
export class PathFileKey {
    constructor(key, name) {
        this.key = key;
        this.name = name;
    }
    equals(otherKey) {
        if (otherKey != null &&
            otherKey.name &&
            otherKey.key &&
            this.name &&
            this.key &&
            otherKey.name === this.name &&
            otherKey.key === this.key) {
            return true;
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vcGF0aC1mcmFtZXdvcmsvIiwic291cmNlcyI6WyJwYXRoLWZyYW1ld29yay9mb3JtL2ZpZWxkL2ZpbGUtdXBsb2FkL2ZpbGUtdXBsb2FkLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBYyxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUM5RSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFTakgsSUFBYSxtQkFBbUIsR0FBaEMsTUFBYSxtQkFBbUI7SUFTNUIsWUFBb0IsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUZwQyxlQUFVLEdBQUcsS0FBSyxDQUFDO0lBR25CLENBQUM7SUFFRCxVQUFVLENBQUMsS0FBZ0I7UUFDdkIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDeEIsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQsY0FBYyxDQUFDLEtBQUs7UUFDaEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDdkIsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3hCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQzVCLENBQUM7SUFFRCxVQUFVLENBQUMsS0FBSztRQUNaLElBQUksQ0FBQyxVQUFVLENBQUMsS0FB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UmVmLCBJbnB1dCwgT3V0cHV0LCBWaWV3Q2hpbGR9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7VmFsdWVGaWVsZH0gZnJvbSBcIi4uL3ZhbHVlLWZpZWxkXCI7XHJcbmltcG9ydCB7SHR0cENsaWVudCwgSHR0cEV2ZW50LCBIdHRwRXZlbnRUeXBlLCBIdHRwUGFyYW1zLCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlfSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uL2h0dHBcIjtcclxuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQge0lGb3JtfSBmcm9tIFwiLi4vLi4vLi4vcGF0aGludGVyZmFjZVwiO1xyXG5pbXBvcnQge1RyYW5zbGF0aW9uU2VydmljZX0gZnJvbSBcIi4uLy4uLy4uL3NlcnZpY2UvdHJhbnNsYXRpb24uc2VydmljZVwiO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogXCJwYXRoLWZpbGUtdXBsb2FkXCIsXHJcbiAgICB0ZW1wbGF0ZVVybDogXCJmaWxlLXVwbG9hZC5jb21wb25lbnQuaHRtbFwiXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGaWxlVXBsb2FkQ29tcG9uZW50IHtcclxuICAgIEBJbnB1dChcImZpZWxkXCIpXHJcbiAgICBAT3V0cHV0KFwiZmllbGRcIilcclxuICAgIGZpZWxkOiBGaWxlVXBsb2FkRmllbGQ7XHJcblxyXG4gICAgQFZpZXdDaGlsZChcImZpbGVJbnB1dFwiLCB7c3RhdGljOiB0cnVlfSlcclxuICAgIGZpbGVJbnB1dFJlZmVyZW5jZTogRWxlbWVudFJlZjtcclxuICAgIGRyYWdBY3RpdmUgPSBmYWxzZTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHtcclxuICAgIH1cclxuXHJcbiAgICBvbkRyb3BGaWxlKGV2ZW50OiBEcmFnRXZlbnQpIHtcclxuICAgICAgICB0aGlzLmRyYWdBY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIHRoaXMudXBsb2FkRmlsZShldmVudC5kYXRhVHJhbnNmZXIuZmlsZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uRHJhZ092ZXJGaWxlKGV2ZW50KSB7XHJcbiAgICAgICAgdGhpcy5kcmFnQWN0aXZlID0gdHJ1ZTtcclxuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uRHJhZ0xlYXZlKCkge1xyXG4gICAgICAgIHRoaXMuZHJhZ0FjdGl2ZSA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEZpbGUoZXZlbnQpIHtcclxuICAgICAgICB0aGlzLnVwbG9hZEZpbGUoZXZlbnQudGFyZ2V0LmZpbGVzKTtcclxuICAgIH1cclxuXHJcbiAgICB1cGxvYWRGaWxlKGZpbGVzOiBGaWxlTGlzdCkge1xyXG4gICAgICAgIGlmIChmaWxlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJObyBmaWxlIHNlbGVjdGVkIVwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gY2hlY2sgaWYgZmlsZSBsaW1pdCBpcyBleGNlZWRlZFxyXG4gICAgICAgIGlmICghdGhpcy5maWVsZC5jaGVja0ZpbGVMaW1pdChmaWxlcy5sZW5ndGgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVzZXRGaWxlVXBsb2FkRWxlbWVudCgpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGNoZWNrIGZpbGUgc2l6ZXNcclxuICAgICAgICBpZiAoIXRoaXMuZmllbGQuY2hlY2tGaWxlU2l6ZShmaWxlcykpIHtcclxuICAgICAgICAgICAgdGhpcy5yZXNldEZpbGVVcGxvYWRFbGVtZW50KCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gdXBsb2FkIHN1Ym1pdHRlZCBmaWxlc1xyXG4gICAgICAgIEFycmF5LmZyb20oZmlsZXMpLmZvckVhY2goKGZpbGUpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5kb1VwbG9hZCh0aGlzLmZpZWxkLmdldEZvcm0oKS5nZXRBcHAoKS5nZXRCYWNrZW5kVXJsKCkgKyB0aGlzLmZpZWxkLnVybCwgZmlsZSlcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5VcGxvYWRQcm9ncmVzcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVyY2VudERvbmU6IG51bWJlciA9IE1hdGgucm91bmQoMTAwICogZXZlbnQubG9hZGVkIC8gZXZlbnQudG90YWwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHVwbG9hZEZpbGUgPSB0aGlzLmZpZWxkLmZpbmRDdXJyZW50VXBsb2FkKGZpbGUubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodXBsb2FkRmlsZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZSA9IHRoaXMuYWRkTmV3UGF0aEZpbGUoZmlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnVwbG9hZFByb2dyZXNzID0gcGVyY2VudERvbmU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgdXBsb2FkRmlsZSA9IHRoaXMuZmllbGQuZmluZEN1cnJlbnRVcGxvYWQoZmlsZS5uYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cGxvYWRGaWxlID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlID0gdGhpcy5hZGROZXdQYXRoRmlsZShmaWxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleTogUGF0aEZpbGVLZXkgPSBuZXcgUGF0aEZpbGVLZXkoZXZlbnQuYm9keVtcImtleVwiXVtcImtleVwiXSwgZXZlbnQuYm9keVtcImtleVwiXVtcIm5hbWVcIl0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS5rZXkgPSBrZXk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnVwbG9hZEZpbmlzaGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUudXBsb2FkU3VjY2Vzc2Z1bCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkLnVwZGF0ZVJlcXVpcmVkU3RhdHVzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJVcGxvYWQgRXJyb3I6XCIsIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVwbG9hZEZpbGUgPSB0aGlzLmZpZWxkLmZpbmRDdXJyZW50VXBsb2FkKGZpbGUubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cGxvYWRGaWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnNpemVTdHJpbmcgPSBcIkVycm9yXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnVwbG9hZEZpbmlzaGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3I6IGZpbGUgc2hvdWxkIGV4aXN0IChcIiArIGZpbGUubmFtZSArIFwiKVwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc2V0RmlsZVVwbG9hZEVsZW1lbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXRGaWxlVXBsb2FkRWxlbWVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhZGROZXdQYXRoRmlsZShmaWxlKTogUGF0aEZpbGUge1xyXG4gICAgICAgIGNvbnN0IHVwbG9hZEZpbGUgPSBuZXcgUGF0aEZpbGUoKTtcclxuICAgICAgICB1cGxvYWRGaWxlLm5hbWUgPSBmaWxlLm5hbWU7XHJcbiAgICAgICAgdXBsb2FkRmlsZS5zaXplID0gZmlsZS5zaXplO1xyXG4gICAgICAgIHVwbG9hZEZpbGUuc2l6ZVN0cmluZyA9IHRoaXMuZmllbGQuZ2V0UmVhZGFibGVGaWxlU2l6ZVN0cmluZyhmaWxlLnNpemUpO1xyXG4gICAgICAgIHVwbG9hZEZpbGUuYWN0aXZlID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLmZpZWxkLnZhbHVlLnB1c2godXBsb2FkRmlsZSk7XHJcbiAgICAgICAgdGhpcy5maWVsZC5zb3J0VmFsdWVzKCk7XHJcbiAgICAgICAgcmV0dXJuIHVwbG9hZEZpbGU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXNldEZpbGVVcGxvYWRFbGVtZW50KCk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGNvdW50ID0gdGhpcy5maWVsZC52YWx1ZS5yZWR1Y2UoKGFjYywgY3VyKSA9PiAhY3VyLnVwbG9hZEZpbmlzaGVkID8gKythY2MgOiBhY2MsIDApO1xyXG4gICAgICAgIGlmIChjb3VudCA9PT0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLmZpbGVJbnB1dFJlZmVyZW5jZS5uYXRpdmVFbGVtZW50LnZhbHVlID0gXCJcIjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkb1VwbG9hZCh1cmw6IHN0cmluZywgZmlsZTogRmlsZSk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcclxuXHJcbiAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcclxuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoXCJ1cGxvYWRcIiwgZmlsZSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIHBhcmFtczogcGFyYW1zLFxyXG4gICAgICAgICAgICByZXBvcnRQcm9ncmVzczogdHJ1ZSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjb25zdCByZXEgPSBuZXcgSHR0cFJlcXVlc3QoXCJQT1NUXCIsIHVybCwgZm9ybURhdGEsIG9wdGlvbnMpO1xyXG4gICAgICAgIHJldHVybiA8YW55PnRoaXMuaHR0cC5yZXF1ZXN0KHJlcSk7IC8vIDxhbnk+IGZpeGVzIFRTMjcxOVxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEZpbGVVcGxvYWRGaWVsZCBleHRlbmRzIFZhbHVlRmllbGQ8UGF0aEZpbGVbXT4ge1xyXG5cclxuICAgIHByaXZhdGUgX3VybDogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBfbXVsdGlwbGUgPSB0cnVlO1xyXG4gICAgcHJpdmF0ZSBfYWNjZXB0ZWRGaWxlVHlwZXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBwcml2YXRlIF9maWxlVXBsb2FkUmVxdWlyZWQ6IGJvb2xlYW47XHJcbiAgICBwcml2YXRlIF9maWxlTGltaXQgPSAwO1xyXG4gICAgcHJpdmF0ZSBfc2luZ2xlRmlsZVNpemVMaW1pdCA9IDA7XHJcbiAgICBwcml2YXRlIF9hbGxGaWxlc1NpemVMaW1pdCA9IDA7XHJcblxyXG4gICAgY29uc3RydWN0b3IoZm9ybTogSUZvcm0sIHRyYW5zbGF0aW9uU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlKSB7XHJcbiAgICAgICAgc3VwZXIoZm9ybSwgdHJhbnNsYXRpb25TZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLnZhbHVlID0gW107XHJcbiAgICAgICAgdGhpcy5fYWNjZXB0ZWRGaWxlVHlwZXMucHVzaChcIiouKlwiKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZVJlcXVpcmVkU3RhdHVzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0VmFsdWUodmFsdWU6IFBhdGhGaWxlW10pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBmaWxlczogUGF0aEZpbGVbXSA9IFtdO1xyXG4gICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiB2YWx1ZSkge1xyXG4gICAgICAgICAgICBjb25zdCBmaWxlID0gT2JqZWN0LmFzc2lnbihuZXcgUGF0aEZpbGUoKSwgaXRlbSk7XHJcbiAgICAgICAgICAgIGZpbGUua2V5ID0gT2JqZWN0LmFzc2lnbihuZXcgUGF0aEZpbGVLZXkobnVsbCwgbnVsbCksIGl0ZW0ua2V5KTtcclxuICAgICAgICAgICAgZmlsZXMucHVzaChmaWxlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zb3J0VmFsdWVzKCk7XHJcbiAgICAgICAgc3VwZXIuc2V0VmFsdWUoZmlsZXMpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlUmVxdWlyZWRTdGF0dXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc29ydFZhbHVlcygpIHtcclxuICAgICAgICB0aGlzLnZhbHVlLnNvcnQoKGEsIGIpID0+IGEubmFtZS5sb2NhbGVDb21wYXJlKGIubmFtZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCB1cmwoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fdXJsO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCB1cmwodmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX3VybCA9IHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBtdWx0aXBsZSgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fbXVsdGlwbGU7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IG11bHRpcGxlKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICAgICAgdGhpcy5fbXVsdGlwbGUgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgYWNjZXB0ZWRGaWxlVHlwZXMoKTogc3RyaW5nW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9hY2NlcHRlZEZpbGVUeXBlcztcclxuICAgIH1cclxuXHJcbiAgICBzZXQgYWNjZXB0ZWRGaWxlVHlwZXModmFsdWU6IHN0cmluZ1tdKSB7XHJcbiAgICAgICAgdGhpcy5fYWNjZXB0ZWRGaWxlVHlwZXMgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgZmlsZVVwbG9hZFJlcXVpcmVkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9maWxlVXBsb2FkUmVxdWlyZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGZpbGVMaW1pdCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9maWxlTGltaXQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHNpbmdsZUZpbGVTaXplTGltaXQoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2luZ2xlRmlsZVNpemVMaW1pdDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgYWxsRmlsZXNTaXplTGltaXQoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fYWxsRmlsZXNTaXplTGltaXQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlbW92ZShpbmRleDogbnVtYmVyLCBrZXk6IFBhdGhGaWxlS2V5KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGtleSkge1xyXG4gICAgICAgICAgICBjb25zdCBmaWxlOiBQYXRoRmlsZSA9IHRoaXMuZmluZChrZXkpO1xyXG4gICAgICAgICAgICBpZiAoZmlsZSkge1xyXG4gICAgICAgICAgICAgICAgZmlsZS5hY3RpdmUgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVJlcXVpcmVkU3RhdHVzKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy52YWx1ZS5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZmluZChrZXk6IFBhdGhGaWxlS2V5KTogUGF0aEZpbGUge1xyXG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiB0aGlzLnZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWxlLmtleS5lcXVhbHMoa2V5KSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGZpbmRDdXJyZW50VXBsb2FkKG5hbWU6IHN0cmluZyk6IFBhdGhGaWxlIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgdGhpcy52YWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAoZmlsZS5uYW1lID09PSBuYW1lICYmICFmaWxlLnVwbG9hZEZpbmlzaGVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmlsZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdXBkYXRlUmVxdWlyZWRTdGF0dXMoKSB7XHJcbiAgICAgICAgbGV0IHVwbG9hZEluUHJvZ3Jlc3NDb3VudCA9IDA7XHJcbiAgICAgICAgbGV0IHVwbG9hZFN1Y2Nlc3NmdWxDb3VudCA9IDA7XHJcbiAgICAgICAgdGhpcy52YWx1ZS5mb3JFYWNoKChmaWxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChmaWxlLmFjdGl2ZSAmJiAhZmlsZS51cGxvYWRGaW5pc2hlZCkge1xyXG4gICAgICAgICAgICAgICAgdXBsb2FkSW5Qcm9ncmVzc0NvdW50Kys7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGZpbGUuYWN0aXZlICYmIGZpbGUudXBsb2FkU3VjY2Vzc2Z1bCkge1xyXG4gICAgICAgICAgICAgICAgdXBsb2FkU3VjY2Vzc2Z1bENvdW50Kys7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBsZXQgbmV3U3RhdHVzID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHVwbG9hZEluUHJvZ3Jlc3NDb3VudCA+IDApIHtcclxuICAgICAgICAgICAgLy8gYWx3YXlzIHJlcXVpcmVkIGlmIHVwbG9hZCBpbiBwcm9ncmVzc1xyXG4gICAgICAgICAgICBuZXdTdGF0dXMgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5yZXF1aXJlZCAmJiB1cGxvYWRTdWNjZXNzZnVsQ291bnQgPD0gMCkge1xyXG4gICAgICAgICAgICBuZXdTdGF0dXMgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9maWxlVXBsb2FkUmVxdWlyZWQgPSBuZXdTdGF0dXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNoZWNrRmlsZUxpbWl0KG5ld0ZpbGVzTGVuZ3RoOiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgICAgICBsZXQgYWN0aXZlRmlsZUNvdW50ID0gMDtcclxuICAgICAgICB0aGlzLnZhbHVlLmZvckVhY2goKGZpbGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGZpbGUuYWN0aXZlKSB7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmVGaWxlQ291bnQrKztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmICh0aGlzLmZpbGVMaW1pdCA+IDAgJiYgKChhY3RpdmVGaWxlQ291bnQgKyBuZXdGaWxlc0xlbmd0aCkgPiB0aGlzLmZpbGVMaW1pdCkpIHtcclxuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmdldFRleHQoXCJGaWxlTGltaXRNZXNzYWdlXCIsIFN0cmluZyh0aGlzLmZpbGVMaW1pdCkpO1xyXG4gICAgICAgICAgICB0aGlzLmdldEZvcm0oKS5nZXRBcHAoKS55ZXNObyhtZXNzYWdlLCAoKSA9PiB7fSwgKCkgPT4ge30pO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjaGVja0ZpbGVTaXplKGZpbGVzOiBGaWxlTGlzdCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICh0aGlzLl9zaW5nbGVGaWxlU2l6ZUxpbWl0IHx8IHRoaXMuX2FsbEZpbGVzU2l6ZUxpbWl0KSB7XHJcbiAgICAgICAgICAgIC8vIGNoZWNrIHNpbmdsZSBmaWxlIGxpbWl0XHJcbiAgICAgICAgICAgIGxldCBzaXplU3VtID0gMDtcclxuICAgICAgICAgICAgY29uc3QgZmlsZUFycmF5ID0gQXJyYXkuZnJvbShmaWxlcyk7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlQXJyYXkpIHtcclxuICAgICAgICAgICAgICAgIHNpemVTdW0gKz0gZmlsZS5zaXplO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3NpbmdsZUZpbGVTaXplTGltaXQgPiAwICYmIGZpbGUuc2l6ZSA+IHRoaXMuX3NpbmdsZUZpbGVTaXplTGltaXQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy50cmFuc2xhdGlvblNlcnZpY2UuZ2V0VGV4dChcIkZpbGVTaW5nbGVTaXplTWVzc2FnZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFJlYWRhYmxlRmlsZVNpemVTdHJpbmcodGhpcy5fc2luZ2xlRmlsZVNpemVMaW1pdCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0Rm9ybSgpLmdldEFwcCgpLnllc05vKG1lc3NhZ2UsICgpID0+IHt9LCAoKSA9PiB7fSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIGNoZWNrIHN1bSBsaW1pdFxyXG4gICAgICAgICAgICBpZiAodGhpcy5fYWxsRmlsZXNTaXplTGltaXQgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnZhbHVlLmZvckVhY2goKGZpbGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZS5hY3RpdmUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZVN1bSArPSBmaWxlLnNpemU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWxsRmlsZXNTaXplTGltaXQgPiAwICYmIHNpemVTdW0gPiB0aGlzLl9hbGxGaWxlc1NpemVMaW1pdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5nZXRUZXh0KFwiRmlsZUFsbFNpemVNZXNzYWdlXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0UmVhZGFibGVGaWxlU2l6ZVN0cmluZyh0aGlzLl9hbGxGaWxlc1NpemVMaW1pdCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0Rm9ybSgpLmdldEFwcCgpLnllc05vKG1lc3NhZ2UsICgpID0+IHt9LCAoKSA9PiB7fSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRSZWFkYWJsZUZpbGVTaXplU3RyaW5nKGJ5dGVTaXplOiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCBpID0gLTE7XHJcbiAgICAgICAgY29uc3QgYnl0ZVVuaXRzID0gW1wiIGtCXCIsIFwiIE1CXCIsIFwiIEdCXCIsIFwiIFRCXCIsIFwiIFBCXCIsIFwiIEVCXCIsIFwiIFpCXCIsIFwiIFlCXCJdO1xyXG4gICAgICAgIGRvIHtcclxuICAgICAgICAgICAgYnl0ZVNpemUgPSBieXRlU2l6ZSAvIDEwMjQ7XHJcbiAgICAgICAgICAgIGkrKztcclxuICAgICAgICB9IHdoaWxlIChieXRlU2l6ZSA+IDEwMjQpO1xyXG5cclxuICAgICAgICByZXR1cm4gTWF0aC5tYXgoYnl0ZVNpemUsIDAuMSkudG9GaXhlZCgxKSArIGJ5dGVVbml0c1tpXTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZG93bmxvYWQoa2V5OiBQYXRoRmlsZUtleSkge1xyXG4gICAgICAgIHdpbmRvdy5sb2NhdGlvbi5hc3NpZ24odGhpcy5nZXRGb3JtKCkuZ2V0QXBwKCkuZ2V0QmFja2VuZFVybCgpICsgdGhpcy51cmwgKyBcIi9cIiArIGtleS5rZXkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmcm9tSnNvbihtb2RlbEZvcm1GaWVsZCkge1xyXG4gICAgICAgIHN1cGVyLmZyb21Kc29uKG1vZGVsRm9ybUZpZWxkKTtcclxuICAgICAgICB0aGlzLnR5cGUgPSBcImZpbGVVcGxvYWRcIjtcclxuICAgICAgICBpZiAobW9kZWxGb3JtRmllbGRbXCJ1cmxcIl0pIHtcclxuICAgICAgICAgICAgdGhpcy51cmwgPSBtb2RlbEZvcm1GaWVsZFtcInVybFwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsRm9ybUZpZWxkW1wibXVsdGlwbGVcIl0gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLm11bHRpcGxlID0gbW9kZWxGb3JtRmllbGRbXCJtdWx0aXBsZVwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsRm9ybUZpZWxkW1wiYWNjZXB0ZWRGaWxlVHlwZXNcIl0pIHtcclxuICAgICAgICAgICAgdGhpcy5hY2NlcHRlZEZpbGVUeXBlcyA9IG1vZGVsRm9ybUZpZWxkW1wiYWNjZXB0ZWRGaWxlVHlwZXNcIl07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbEZvcm1GaWVsZFtcImZpbGVMaW1pdFwiXSkge1xyXG4gICAgICAgICAgICB0aGlzLl9maWxlTGltaXQgPSBtb2RlbEZvcm1GaWVsZFtcImZpbGVMaW1pdFwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsRm9ybUZpZWxkW1wic2luZ2xlRmlsZVNpemVMaW1pdFwiXSkge1xyXG4gICAgICAgICAgICB0aGlzLl9zaW5nbGVGaWxlU2l6ZUxpbWl0ID0gbW9kZWxGb3JtRmllbGRbXCJzaW5nbGVGaWxlU2l6ZUxpbWl0XCJdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobW9kZWxGb3JtRmllbGRbXCJhbGxGaWxlc1NpemVMaW1pdFwiXSkge1xyXG4gICAgICAgICAgICB0aGlzLl9hbGxGaWxlc1NpemVMaW1pdCA9IG1vZGVsRm9ybUZpZWxkW1wiYWxsRmlsZXNTaXplTGltaXRcIl07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudXBkYXRlUmVxdWlyZWRTdGF0dXMoKTtcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBQYXRoRmlsZSB7XHJcbiAgICBhY3RpdmU6IGJvb2xlYW47IC8vIGZpbGUgZGVsZXRlZDogYWN0aXZlID09PSBmYWxzZVxyXG4gICAgdXBsb2FkRmluaXNoZWQgPSBmYWxzZTtcclxuICAgIHVwbG9hZFN1Y2Nlc3NmdWwgPSBmYWxzZTtcclxuICAgIHVwbG9hZFByb2dyZXNzID0gMDtcclxuICAgIG5hbWU6IHN0cmluZztcclxuICAgIHNpemVTdHJpbmc6IHN0cmluZztcclxuICAgIHNpemUgPSAwO1xyXG4gICAga2V5OiBQYXRoRmlsZUtleTtcclxufVxyXG5cclxuLy8gVE9ETyB1bmlmeSB3aXRoIGxpc3Qga2V5XHJcbi8vIHRzbGludDpkaXNhYmxlOm1heC1jbGFzc2VzLXBlci1maWxlXHJcbmV4cG9ydCBjbGFzcyBQYXRoRmlsZUtleSB7XHJcbiAgICBrZXk6IHN0cmluZztcclxuICAgIG5hbWU6IGFueTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihrZXk6IHN0cmluZywgbmFtZTogYW55KSB7XHJcbiAgICAgICAgdGhpcy5rZXkgPSBrZXk7XHJcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZXF1YWxzKG90aGVyS2V5OiBQYXRoRmlsZUtleSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmIChvdGhlcktleSAhPSBudWxsICYmXHJcbiAgICAgICAgICAgIG90aGVyS2V5Lm5hbWUgJiZcclxuICAgICAgICAgICAgb3RoZXJLZXkua2V5ICYmXHJcbiAgICAgICAgICAgIHRoaXMubmFtZSAmJlxyXG4gICAgICAgICAgICB0aGlzLmtleSAmJlxyXG4gICAgICAgICAgICBvdGhlcktleS5uYW1lID09PSB0aGlzLm5hbWUgJiZcclxuICAgICAgICAgICAgb3RoZXJLZXkua2V5ID09PSB0aGlzLmtleSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=