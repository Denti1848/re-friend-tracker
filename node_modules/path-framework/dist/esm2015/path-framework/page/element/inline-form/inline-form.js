import * as tslib_1 from "tslib";
import { PageElement, Key } from "../page-element";
import { PathService } from "../../../service/path.service";
import { Inject } from "@angular/core";
import { FormFunction } from "../../../form/form-function";
import { TranslationService } from "../../../service/translation.service";
import { FocusUtility } from "../../../form/focus-utility";
let InlineForm = class InlineForm extends PageElement {
    constructor(app, pathService, translationService) {
        super(app);
        this.pathService = pathService;
        this.translationService = translationService;
    }
    get url() {
        return this._url;
    }
    set url(value) {
        this._url = value;
    }
    get formId() {
        return this._formId;
    }
    set formId(value) {
        this._formId = value;
    }
    get form() {
        return this._form;
    }
    set form(value) {
        this._form = value;
    }
    get page() {
        return this._page;
    }
    set page(value) {
        this._page = value;
    }
    fromJson(modelFormField) {
        super.fromJson(modelFormField);
        if (modelFormField["form"] != null) {
            this.formId = modelFormField["form"];
        }
        if (modelFormField["page"] != null) {
            this.page = modelFormField["page"];
        }
        if (modelFormField["key"] == null) {
            // only set key if not set by model
            this.key = this.parentPageElement != null ? this.parentPageElement.key : null;
        }
    }
    loadNextForm(forward) {
        if (this._url != null) {
            this.pathService.serverGet(this.app.getBackendUrl(), this.url, (data) => {
                if (data != null && data["length"] != null && data.length > 0) {
                    let foundNewKey = false;
                    if (this._currentKey == null) {
                        const firstItem = data[0];
                        this._currentKey = new Key(firstItem["key"]["key"], firstItem["key"]["name"]);
                        foundNewKey = true;
                    }
                    else {
                        let counter = 0;
                        for (const item of data) {
                            counter++;
                            if (item["key"]["key"] === this._currentKey.getKey() && item["key"]["name"] === this._currentKey.getName()) {
                                if (forward && data.length > counter) {
                                    this._currentKey = new Key(data[counter]["key"]["key"], data[counter]["key"]["name"]);
                                    foundNewKey = true;
                                }
                                else if (!forward && counter > 1) {
                                    this._currentKey = new Key(data[counter - 2]["key"]["key"], data[counter - 2]["key"]["name"]);
                                    foundNewKey = true;
                                }
                                break;
                            }
                        }
                    }
                    if (this._currentKey != null && foundNewKey) {
                        console.log("load next inline form with key " + this._currentKey.getKey() + "/" + this._currentKey.getName());
                        const formFunction = new FormFunction();
                        formFunction.save = (formdata) => {
                            this.loadNextForm(true);
                        };
                        formFunction.cancel = () => {
                            this.loadNextForm(true);
                        };
                        formFunction.delete = (formdata) => {
                            this.loadNextForm(false);
                        };
                        this._form = this.app.createForm(this._formId, this._currentKey, null, formFunction, this);
                        this.name = this._form.title;
                        FocusUtility.focusFirstField(this.form);
                    }
                    else {
                        this._form = null;
                        if (this.page == null) {
                            this.app.navigateBack();
                        }
                        else {
                            this.app.setCurrentPage(this.page, this);
                        }
                    }
                }
                else {
                    window.alert(this.translationService.getText("NoDataError"));
                    this.app.navigateBack();
                }
            }, null);
        }
    }
};
InlineForm = tslib_1.__decorate([
    tslib_1.__param(1, Inject(PathService)),
    tslib_1.__param(2, Inject(TranslationService))
], InlineForm);
export { InlineForm };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5saW5lLWZvcm0uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9wYXRoLWZyYW1ld29yay8iLCJzb3VyY2VzIjpbInBhdGgtZnJhbWV3b3JrL3BhZ2UvZWxlbWVudC9pbmxpbmUtZm9ybS9pbmxpbmUtZm9ybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sK0JBQStCLENBQUM7QUFDMUQsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sNkJBQTZCLENBQUM7QUFDekQsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sc0NBQXNDLENBQUM7QUFDeEUsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBR3pELElBQWEsVUFBVSxHQUF2QixNQUFhLFVBQVcsU0FBUSxXQUFXO0lBT3ZDLFlBQVksR0FBYSxFQUNnQixXQUF3QixFQUNqQixrQkFBc0M7UUFDbEYsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRjBCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ2pCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7SUFFdEYsQ0FBQztJQUVELElBQUksR0FBRztRQUNILE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNyQixDQUFDO0lBRUQsSUFBSSxHQUFHLENBQUMsS0FBYTtRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztJQUN0QixDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ04sT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFJLE1BQU0sQ0FBQyxLQUFhO1FBQ3BCLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxJQUFJLElBQUk7UUFDSixPQUFPLElB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QUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7d0JBQzdCLFlBQVksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO3FCQUMzQzt5QkFBTTt3QkFDSCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQzt3QkFDbEIsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRTs0QkFDbkIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQzt5QkFDM0I7NkJBQU07NEJBQ0gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQzt5QkFDNUM7cUJBQ0o7aUJBQ0o7cUJBQU07b0JBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7b0JBQzdELElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUM7aUJBQzNCO1lBQ0wsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ1o7SUFDTCxDQUFDO0NBQ0osQ0FBQTtBQWxIWSxVQUFVO0lBUU4sbUJBQUEsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQ25CLG1CQUFBLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO0dBVDlCLFVBQVUsQ0FrSHRCO1NBbEhZLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Zvcm19IGZyb20gXCIuLi8uLi8uLi9mb3JtL2Zvcm0uY29tcG9uZW50XCI7XHJcbmltcG9ydCB7UGFnZUVsZW1lbnQsIEtleX0gZnJvbSBcIi4uL3BhZ2UtZWxlbWVudFwiO1xyXG5pbXBvcnQge1BhdGhTZXJ2aWNlfSBmcm9tIFwiLi4vLi4vLi4vc2VydmljZS9wYXRoLnNlcnZpY2VcIjtcclxuaW1wb3J0IHtJbmplY3R9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7Rm9ybUZ1bmN0aW9ufSBmcm9tIFwiLi4vLi4vLi4vZm9ybS9mb3JtLWZ1bmN0aW9uXCI7XHJcbmltcG9ydCB7VHJhbnNsYXRpb25TZXJ2aWNlfSBmcm9tIFwiLi4vLi4vLi4vc2VydmljZS90cmFuc2xhdGlvbi5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7Rm9jdXNVdGlsaXR5fSBmcm9tIFwiLi4vLi4vLi4vZm9ybS9mb2N1cy11dGlsaXR5XCI7XHJcbmltcG9ydCB7SVBhdGhBcHB9IGZyb20gXCIuLi8uLi8uLi9wYXRoaW50ZXJmYWNlXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgSW5saW5lRm9ybSBleHRlbmRzIFBhZ2VFbGVtZW50IHtcclxuICAgIHByaXZhdGUgX2Zvcm1JZDogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBfdXJsOiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIF9mb3JtOiBGb3JtO1xyXG4gICAgcHJpdmF0ZSBfY3VycmVudEtleTogS2V5O1xyXG4gICAgcHJpdmF0ZSBfcGFnZTogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGFwcDogSVBhdGhBcHAsXHJcbiAgICAgICAgICAgICAgICBASW5qZWN0KFBhdGhTZXJ2aWNlKSBwcml2YXRlIHBhdGhTZXJ2aWNlOiBQYXRoU2VydmljZSxcclxuICAgICAgICAgICAgICAgIEBJbmplY3QoVHJhbnNsYXRpb25TZXJ2aWNlKSBwcml2YXRlIHRyYW5zbGF0aW9uU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlKSB7XHJcbiAgICAgICAgc3VwZXIoYXBwKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdXJsKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3VybDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgdXJsKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLl91cmwgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgZm9ybUlkKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Zvcm1JZDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgZm9ybUlkKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLl9mb3JtSWQgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgZm9ybSgpOiBGb3JtIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZm9ybTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgZm9ybSh2YWx1ZTogRm9ybSkge1xyXG4gICAgICAgIHRoaXMuX2Zvcm0gPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcGFnZSgpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wYWdlO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCBwYWdlKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLl9wYWdlID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGZyb21Kc29uKG1vZGVsRm9ybUZpZWxkKSB7XHJcbiAgICAgICAgc3VwZXIuZnJvbUpzb24obW9kZWxGb3JtRmllbGQpO1xyXG4gICAgICAgIGlmIChtb2RlbEZvcm1GaWVsZFtcImZvcm1cIl0gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1JZCA9IG1vZGVsRm9ybUZpZWxkW1wiZm9ybVwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsRm9ybUZpZWxkW1wicGFnZVwiXSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGFnZSA9IG1vZGVsRm9ybUZpZWxkW1wicGFnZVwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsRm9ybUZpZWxkW1wia2V5XCJdID09IG51bGwpIHtcclxuICAgICAgICAgICAgLy8gb25seSBzZXQga2V5IGlmIG5vdCBzZXQgYnkgbW9kZWxcclxuICAgICAgICAgICAgdGhpcy5rZXkgPSB0aGlzLnBhcmVudFBhZ2VFbGVtZW50ICE9IG51bGwgPyB0aGlzLnBhcmVudFBhZ2VFbGVtZW50LmtleSA6IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBsb2FkTmV4dEZvcm0oZm9yd2FyZDogYm9vbGVhbikge1xyXG4gICAgICAgIGlmICh0aGlzLl91cmwgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICB0aGlzLnBhdGhTZXJ2aWNlLnNlcnZlckdldCh0aGlzLmFwcC5nZXRCYWNrZW5kVXJsKCksIHRoaXMudXJsLCAoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSAhPSBudWxsICYmIGRhdGFbXCJsZW5ndGhcIl0gIT0gbnVsbCAmJiBkYXRhLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZm91bmROZXdLZXkgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fY3VycmVudEtleSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0SXRlbSA9IGRhdGFbMF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRLZXkgPSBuZXcgS2V5KGZpcnN0SXRlbVtcImtleVwiXVtcImtleVwiXSwgZmlyc3RJdGVtW1wia2V5XCJdW1wibmFtZVwiXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kTmV3S2V5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgY291bnRlciA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudGVyKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbVtcImtleVwiXVtcImtleVwiXSA9PT0gdGhpcy5fY3VycmVudEtleS5nZXRLZXkoKSAmJiBpdGVtW1wia2V5XCJdW1wibmFtZVwiXSA9PT0gdGhpcy5fY3VycmVudEtleS5nZXROYW1lKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9yd2FyZCAmJiBkYXRhLmxlbmd0aCA+IGNvdW50ZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudEtleSA9IG5ldyBLZXkoZGF0YVtjb3VudGVyXVtcImtleVwiXVtcImtleVwiXSwgZGF0YVtjb3VudGVyXVtcImtleVwiXVtcIm5hbWVcIl0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZE5ld0tleSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZm9yd2FyZCAmJiBjb3VudGVyID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50S2V5ID0gbmV3IEtleShkYXRhW2NvdW50ZXIgLSAyXVtcImtleVwiXVtcImtleVwiXSwgZGF0YVtjb3VudGVyIC0gMl1bXCJrZXlcIl1bXCJuYW1lXCJdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmROZXdLZXkgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fY3VycmVudEtleSAhPSBudWxsICYmIGZvdW5kTmV3S2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibG9hZCBuZXh0IGlubGluZSBmb3JtIHdpdGgga2V5IFwiICsgdGhpcy5fY3VycmVudEtleS5nZXRLZXkoKSArIFwiL1wiICsgdGhpcy5fY3VycmVudEtleS5nZXROYW1lKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3JtRnVuY3Rpb246IEZvcm1GdW5jdGlvbiA9IG5ldyBGb3JtRnVuY3Rpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUZ1bmN0aW9uLnNhdmUgPSAoZm9ybWRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkTmV4dEZvcm0odHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1GdW5jdGlvbi5jYW5jZWwgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWROZXh0Rm9ybSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUZ1bmN0aW9uLmRlbGV0ZSA9IChmb3JtZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWROZXh0Rm9ybShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Zvcm0gPSB0aGlzLmFwcC5jcmVhdGVGb3JtKHRoaXMuX2Zvcm1JZCwgdGhpcy5fY3VycmVudEtleSwgbnVsbCwgZm9ybUZ1bmN0aW9uLCB0aGlzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5fZm9ybS50aXRsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgRm9jdXNVdGlsaXR5LmZvY3VzRmlyc3RGaWVsZCh0aGlzLmZvcm0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Zvcm0gPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYWdlID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwLm5hdmlnYXRlQmFjaygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHAuc2V0Q3VycmVudFBhZ2UodGhpcy5wYWdlLCB0aGlzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmFsZXJ0KHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmdldFRleHQoXCJOb0RhdGFFcnJvclwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHAubmF2aWdhdGVCYWNrKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=