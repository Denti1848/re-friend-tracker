import * as tslib_1 from "tslib";
import { Component, Input, Output, ElementRef } from "@angular/core";
import { ValueField } from "../value-field";
import { AutoCompleteFieldEntry } from "./auto-complete-field-entry";
import { Key } from "../../../page/element/page-element";
import { FormFunction } from "../../form-function";
import { KeyUtility } from "../../../utility/key-utility";
var AutoCompleteComponent = /** @class */ (function () {
    function AutoCompleteComponent(myElement) {
        this._elementRef = myElement;
    }
    AutoCompleteComponent.prototype.handleClick = function (event) {
        if (this.field.isReadonly()) {
            return;
        }
        var clickedComponent = event.target;
        var inside = false;
        do {
            if (clickedComponent === this._elementRef.nativeElement) {
                inside = true;
            }
            clickedComponent = clickedComponent.parentNode;
        } while (clickedComponent);
        if (!inside) {
            this.field.clearFilteredList();
        }
        if (!this.field.valueSet) {
            this.field.query = null;
            this.field.setValue(null);
        }
    };
    AutoCompleteComponent.ctorParameters = function () { return [
        { type: ElementRef }
    ]; };
    tslib_1.__decorate([
        Input("field"),
        Output("field")
    ], AutoCompleteComponent.prototype, "field", void 0);
    AutoCompleteComponent = tslib_1.__decorate([
        Component({
            selector: "path-autocomplete",
            // tslint:disable-next-line
            host: {
                "(document:click)": "handleClick($event)",
            },
            template: "<path-form-field-label [label]=\"field.name\" [required]=\"field.required\"></path-form-field-label>\r\n<div [class.col-md-4]=\"field.width == 1\" [class.col-md-10]=\"field.width == 2\">\r\n    <div class=\"input-group\">\r\n        <input #model=\"ngModel\" [readonly]=\"field.isReadonly()\"\r\n               [class.required-field]=\"(!model.valid &&!model.pristine && field.required)\" [required]=\"field.required\"\r\n               #inputElement type=\"text\" [ngModel]=field.query?.text (keyup)=field.filter(inputElement.value,$event)\r\n               (blur)=\"field.focusLost()\" class=\"form-control\" placeholder=\"\">\r\n        <!-- Auto Complete -->\r\n        <div *ngIf=\"field.filteredList.length > 0 && !field.isReadonly()\">\r\n            <div class=\"path-autocomplete list-group\">\r\n                <a *ngFor=\"let item of field.filteredList\" class=\"list-group-item\" href=\"#\"\r\n                   (click)=\"field.select(item)\"><h5>{{item.text}}</h5></a>\r\n            </div>\r\n        </div>\r\n        <!-- Action -->\r\n        <span *ngIf=\"field.detailForm != null\" class=\"input-group-btn\">\r\n                <button (click)=\"field.showDetailForm()\" class=\"btn btn-default\" type=\"button\">{{field.getDetailButtonName()}}</button>\r\n            </span>\r\n    </div>\r\n</div>\r\n"
        })
    ], AutoCompleteComponent);
    return AutoCompleteComponent;
}());
export { AutoCompleteComponent };
var AutoCompleteField = /** @class */ (function (_super) {
    tslib_1.__extends(AutoCompleteField, _super);
    function AutoCompleteField(form, translationService, pathService) {
        var _this = _super.call(this, form, translationService) || this;
        _this.form = form;
        _this.translationService = translationService;
        _this.pathService = pathService;
        _this._filteredList = [];
        _this._data = [];
        _this._dataLoaded = false;
        _this._valueSet = false;
        return _this;
    }
    AutoCompleteField.prototype.isReadonly = function () {
        return _super.prototype.isReadonly.call(this) && this.isInitialValueSet;
    };
    AutoCompleteField.prototype.filter = function (query, event) {
        // do not filter readonly fields
        if (this.isReadonly()) {
            return;
        }
        // do not filter on simple tab focus change
        if (event.keyCode === 9) {
            return;
        }
        this._valueSet = false;
        if (query !== null && query.length > 0 && query.replace(/\s/g, "").length === 0) {
            /* space: all */
            this._filteredList = this._data.filter(function (entry) {
                return entry.active;
            }.bind(this));
        }
        else if (query !== null && query !== "") {
            /* search term: filter */
            query = query.trim();
            this._filteredList = this._data.filter(function (entry) {
                var e_1, _a;
                if (!entry.active) {
                    return false;
                }
                var entryName = entry.text;
                if (entryName.toLowerCase().indexOf(query.toLowerCase()) > -1) {
                    return true;
                }
                else if (this._wordSearchEnabled) {
                    var tokens = entryName.toLowerCase().split(" ");
                    try {
                        for (var tokens_1 = tslib_1.__values(tokens), tokens_1_1 = tokens_1.next(); !tokens_1_1.done; tokens_1_1 = tokens_1.next()) {
                            var token = tokens_1_1.value;
                            if (token.startsWith(query.toLowerCase())) {
                                return true;
                            }
                        }
                    }
                    catch (e_1_1) { e_1 = { error: e_1_1 }; }
                    finally {
                        try {
                            if (tokens_1_1 && !tokens_1_1.done && (_a = tokens_1.return)) _a.call(tokens_1);
                        }
                        finally { if (e_1) throw e_1.error; }
                    }
                }
                return false;
            }.bind(this));
        }
        else {
            /* empty: nothing */
            this.clearFilteredList();
        }
        this._filteredList.sort();
    };
    AutoCompleteField.prototype.select = function (item) {
        this.setValue(item.key);
    };
    AutoCompleteField.prototype.focusLost = function () {
        var _this = this;
        window.setTimeout(function () {
            if (!_this.valueSet) {
                // force angular to update query.text value
                if (_this.value == null) {
                    _this.resetDisplay(null);
                }
                else {
                    _this.resetDisplay(_this.value["key"]);
                }
            }
        }, 1);
    };
    AutoCompleteField.prototype.setValue = function (value) {
        var e_2, _a;
        var oldValue = this.value;
        // accept key values and complex objects
        if (value != null && value["key"] != null) {
            value = value["key"];
            this._keyType = value["name"];
        }
        this._valueSet = value != null;
        this.clearFilteredList();
        _super.prototype.setValue.call(this, value);
        this.query = null;
        this.resetDisplay(value);
        // reload dependent autocomplete fields
        if (oldValue !== this.value) {
            try {
                for (var _b = tslib_1.__values(this.getForm().getFields()), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var field = _c.value;
                    if (field instanceof AutoCompleteField) {
                        if (field.id !== this.id) {
                            var autoCompleteField = field;
                            if (KeyUtility.variableExists(autoCompleteField.url, this.id)) {
                                autoCompleteField.load();
                            }
                        }
                    }
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_2) throw e_2.error; }
            }
        }
    };
    AutoCompleteField.prototype.load = function () {
        var e_3, _a;
        var _this = this;
        this.dataLoaded = false;
        var url = this.url;
        try {
            for (var _b = tslib_1.__values(this.getForm().getFields()), _c = _b.next(); !_c.done; _c = _b.next()) {
                var field = _c.value;
                if (field instanceof ValueField) {
                    var valueField = field;
                    url = KeyUtility.replaceVariable(url, valueField.id, valueField.value);
                    console.log(url);
                }
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_3) throw e_3.error; }
        }
        this.pathService.serverGet(this.getForm().getApp().getBackendUrl(), url, function (data) {
            var e_4, _a;
            var dynamicData = [];
            try {
                for (var data_1 = tslib_1.__values(data), data_1_1 = data_1.next(); !data_1_1.done; data_1_1 = data_1.next()) {
                    var item = data_1_1.value;
                    var entry = new AutoCompleteFieldEntry();
                    entry.key = item["key"]["key"];
                    entry.text = item["name"];
                    if (item["active"] != null) {
                        entry.active = item["active"];
                    }
                    else {
                        entry.active = true;
                    }
                    dynamicData.push(entry);
                }
            }
            catch (e_4_1) { e_4 = { error: e_4_1 }; }
            finally {
                try {
                    if (data_1_1 && !data_1_1.done && (_a = data_1.return)) _a.call(data_1);
                }
                finally { if (e_4) throw e_4.error; }
            }
            _this.data = dynamicData;
            _this.dataLoaded = true;
            _this.setValue(_this.value); // force display refresh
        }, null);
    };
    AutoCompleteField.prototype.getDetailButtonName = function () {
        if (this.value == null) {
            return this.translationService.getText("New") + "...";
        }
        else {
            return this.translationService.getText("Detail") + "...";
        }
    };
    AutoCompleteField.prototype.showDetailForm = function () {
        var _this = this;
        var form = null;
        var formFunction = new FormFunction();
        formFunction.save = function (data) {
            _this.getForm().getApp().closeCurrentForm();
            if (data["key"] != null) {
                _this.setValue(data["key"]);
            }
            _this.load();
        };
        formFunction.cancel = function () {
            _this.getForm().getApp().closeCurrentForm();
        };
        formFunction.delete = function (data) {
            _this.getForm().getApp().closeCurrentForm();
            _this.setValue(null);
            _this.load();
        };
        if (this.value == null) {
            form = this.getForm().getApp().createForm(this.detailForm, null, null, formFunction, null);
        }
        else {
            form = this.getForm().getApp().createForm(this.detailForm, new Key(this.value, this._keyType), null, formFunction, null);
        }
        this.form.getApp()["_formStack"].push(form); // TODO
    };
    AutoCompleteField.prototype.clearFilteredList = function () {
        this._filteredList = [];
    };
    AutoCompleteField.prototype.resetDisplay = function (value) {
        var _this = this;
        // must wait with display update until data is loaded
        var displaySetter = function () {
            var e_5, _a;
            var keyValue = value;
            if (!_this.dataLoaded) {
                console.log("waiting...");
                window.setTimeout(function () {
                    displaySetter();
                }, 250);
            }
            else {
                if (keyValue == null) {
                    window.setTimeout(function () {
                        // check value again, may have changed since reset was triggered
                        if (_this.value == null) {
                            _this.query = new AutoCompleteFieldEntry();
                        }
                    }, 1);
                }
                else {
                    var _loop_1 = function (item) {
                        // tslint:disable:triple-equals
                        if (item.key == keyValue) {
                            window.setTimeout(function () {
                                _this.query = item;
                            }, 1);
                            return "break";
                        }
                    };
                    try {
                        for (var _b = tslib_1.__values(_this._data), _c = _b.next(); !_c.done; _c = _b.next()) {
                            var item = _c.value;
                            var state_1 = _loop_1(item);
                            if (state_1 === "break")
                                break;
                        }
                    }
                    catch (e_5_1) { e_5 = { error: e_5_1 }; }
                    finally {
                        try {
                            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                        }
                        finally { if (e_5) throw e_5.error; }
                    }
                }
            }
        };
        displaySetter();
    };
    Object.defineProperty(AutoCompleteField.prototype, "query", {
        get: function () {
            return this._query;
        },
        set: function (value) {
            this._query = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AutoCompleteField.prototype, "data", {
        set: function (value) {
            this._data = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AutoCompleteField.prototype, "filteredList", {
        get: function () {
            return this._filteredList;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AutoCompleteField.prototype, "wordSearchEnabled", {
        set: function (value) {
            this._wordSearchEnabled = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AutoCompleteField.prototype, "valueSet", {
        get: function () {
            return this._valueSet;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AutoCompleteField.prototype, "dataLoaded", {
        get: function () {
            return this._dataLoaded;
        },
        set: function (value) {
            this._dataLoaded = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AutoCompleteField.prototype, "detailForm", {
        get: function () {
            return this._detailForm;
        },
        set: function (value) {
            this._detailForm = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AutoCompleteField.prototype, "url", {
        get: function () {
            return this._url;
        },
        set: function (value) {
            this._url = value;
        },
        enumerable: true,
        configurable: true
    });
    return AutoCompleteField;
}(ValueField));
export { AutoCompleteField };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0by1jb21wbGV0ZS1maWVsZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9wYXRoLWZyYW1ld29yay8iLCJzb3VyY2VzIjpbInBhdGgtZnJhbWV3b3JrL2Zvcm0vZmllbGQvYXV0by1jb21wbGV0ZS9hdXRvLWNvbXBsZXRlLWZpZWxkLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNuRSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFDLHNCQUFzQixFQUFDLE1BQU0sNkJBQTZCLENBQUM7QUFDbkUsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLG9DQUFvQyxDQUFDO0FBS3ZELE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sOEJBQThCLENBQUM7QUFVeEQ7SUFNSSwrQkFBWSxTQUFxQjtRQUM3QixJQUFJLENBQUMsV0FBVyxHQUFHLFNBQVMsQ0FBQztJQUNqQyxDQUFDO0lBRUQsMkNBQVcsR0FBWCxVQUFZLEtBQUs7UUFDYixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDekIsT0FBTztTQUNWO1FBQ0QsSUFBSSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ3BDLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNuQixHQUFHO1lBQ0MsSUFBSSxnQkFBZ0IsS0FBSyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRTtnQkFDckQsTUFBTSxHQUFHLElBQUksQ0FBQzthQUNqQjtZQUNELGdCQUFnQixHQUFHLGdCQUFnQixDQUFDLFVBQVUsQ0FBQztTQUNsRCxRQUFRLGdCQUFnQixFQUFFO1FBQzNCLElBQUksQ0FBQyxNQUFNLEVB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LENBQUM7OztPQUFBO0lBRUQsc0JBQUksZ0RBQWlCO2FBQXJCLFVBQXNCLEtBQWM7WUFDaEMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQztRQUNwQyxDQUFDOzs7T0FBQTtJQUVELHNCQUFJLHVDQUFRO2FBQVo7WUFDSSxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDMUIsQ0FBQzs7O09BQUE7SUFFRCxzQkFBSSx5Q0FBVTthQUFkO1lBQ0ksT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQzVCLENBQUM7YUFFRCxVQUFlLEtBQWM7WUFDekIsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFDN0IsQ0FBQzs7O09BSkE7SUFNRCxzQkFBSSx5Q0FBVTthQUFkO1lBQ0ksT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQzVCLENBQUM7YUFFRCxVQUFlLEtBQWE7WUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFDN0IsQ0FBQzs7O09BSkE7SUFNRCxzQkFBSSxrQ0FBRzthQUFQO1lBQ0ksT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3JCLENBQUM7YUFFRCxVQUFRLEtBQWE7WUFDakIsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7UUFDdEIsQ0FBQzs7O09BSkE7SUFLTCx3QkFBQztBQUFELENBQUMsQUFoUUQsQ0FBdUMsVUFBVSxHQWdRaEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRWxlbWVudFJlZn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHtWYWx1ZUZpZWxkfSBmcm9tIFwiLi4vdmFsdWUtZmllbGRcIjtcclxuaW1wb3J0IHtBdXRvQ29tcGxldGVGaWVsZEVudHJ5fSBmcm9tIFwiLi9hdXRvLWNvbXBsZXRlLWZpZWxkLWVudHJ5XCI7XHJcbmltcG9ydCB7S2V5fSBmcm9tIFwiLi4vLi4vLi4vcGFnZS9lbGVtZW50L3BhZ2UtZWxlbWVudFwiO1xyXG5pbXBvcnQge0lGb3JtLCBJRm9ybUZpZWxkfSBmcm9tIFwiLi4vLi4vLi4vcGF0aGludGVyZmFjZVwiO1xyXG5pbXBvcnQge1RyYW5zbGF0aW9uU2VydmljZX0gZnJvbSBcIi4uLy4uLy4uL3NlcnZpY2UvdHJhbnNsYXRpb24uc2VydmljZVwiO1xyXG5pbXBvcnQge1BhdGhTZXJ2aWNlfSBmcm9tIFwiLi4vLi4vLi4vc2VydmljZS9wYXRoLnNlcnZpY2VcIjtcclxuaW1wb3J0IHtGb3JtfSBmcm9tIFwiLi4vLi4vZm9ybS5jb21wb25lbnRcIjtcclxuaW1wb3J0IHtGb3JtRnVuY3Rpb259IGZyb20gXCIuLi8uLi9mb3JtLWZ1bmN0aW9uXCI7XHJcbmltcG9ydCB7S2V5VXRpbGl0eX0gZnJvbSBcIi4uLy4uLy4uL3V0aWxpdHkva2V5LXV0aWxpdHlcIjtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6IFwicGF0aC1hdXRvY29tcGxldGVcIixcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxyXG4gICAgaG9zdDoge1xyXG4gICAgICAgIFwiKGRvY3VtZW50OmNsaWNrKVwiOiBcImhhbmRsZUNsaWNrKCRldmVudClcIixcclxuICAgIH0sXHJcbiAgICB0ZW1wbGF0ZVVybDogXCJhdXRvLWNvbXBsZXRlLWZpZWxkLmNvbXBvbmVudC5odG1sXCJcclxufSlcclxuZXhwb3J0IGNsYXNzIEF1dG9Db21wbGV0ZUNvbXBvbmVudCB7XHJcbiAgICBASW5wdXQoXCJmaWVsZFwiKVxyXG4gICAgQE91dHB1dChcImZpZWxkXCIpXHJcbiAgICBmaWVsZDogQXV0b0NvbXBsZXRlRmllbGQ7XHJcbiAgICBwcml2YXRlIF9lbGVtZW50UmVmO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG15RWxlbWVudDogRWxlbWVudFJlZikge1xyXG4gICAgICAgIHRoaXMuX2VsZW1lbnRSZWYgPSBteUVsZW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgaGFuZGxlQ2xpY2soZXZlbnQpIHtcclxuICAgICAgICBpZiAodGhpcy5maWVsZC5pc1JlYWRvbmx5KCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgY2xpY2tlZENvbXBvbmVudCA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBsZXQgaW5zaWRlID0gZmFsc2U7XHJcbiAgICAgICAgZG8ge1xyXG4gICAgICAgICAgICBpZiAoY2xpY2tlZENvbXBvbmVudCA9PT0gdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICBpbnNpZGUgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNsaWNrZWRDb21wb25lbnQgPSBjbGlja2VkQ29tcG9uZW50LnBhcmVudE5vZGU7XHJcbiAgICAgICAgfSB3aGlsZSAoY2xpY2tlZENvbXBvbmVudCk7XHJcbiAgICAgICAgaWYgKCFpbnNpZGUpIHtcclxuICAgICAgICAgICAgdGhpcy5maWVsZC5jbGVhckZpbHRlcmVkTGlzdCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuZmllbGQudmFsdWVTZXQpIHtcclxuICAgICAgICAgICAgdGhpcy5maWVsZC5xdWVyeSA9IG51bGw7XHJcbiAgICAgICAgICAgIHRoaXMuZmllbGQuc2V0VmFsdWUobnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQXV0b0NvbXBsZXRlRmllbGQgZXh0ZW5kcyBWYWx1ZUZpZWxkPHN0cmluZz4ge1xyXG4gICAgcHJpdmF0ZSBfcXVlcnk6IEF1dG9Db21wbGV0ZUZpZWxkRW50cnk7XHJcbiAgICBwcml2YXRlIF9maWx0ZXJlZExpc3Q6IEF1dG9Db21wbGV0ZUZpZWxkRW50cnlbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBfZGF0YTogQXV0b0NvbXBsZXRlRmllbGRFbnRyeVtdID0gW107XHJcbiAgICBwcml2YXRlIF9kYXRhTG9hZGVkID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIF93b3JkU2VhcmNoRW5hYmxlZDogYm9vbGVhbjtcclxuICAgIHByaXZhdGUgX3ZhbHVlU2V0ID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIF9kZXRhaWxGb3JtOiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIF9rZXlUeXBlOiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIF91cmw6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgZm9ybTogSUZvcm0sIHByb3RlY3RlZCB0cmFuc2xhdGlvblNlcnZpY2U6IFRyYW5zbGF0aW9uU2VydmljZSwgcHJvdGVjdGVkIHBhdGhTZXJ2aWNlOiBQYXRoU2VydmljZSkge1xyXG4gICAgICAgIHN1cGVyKGZvcm0sIHRyYW5zbGF0aW9uU2VydmljZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGlzUmVhZG9ubHkoKSB7XHJcbiAgICAgICAgcmV0dXJuIHN1cGVyLmlzUmVhZG9ubHkoKSAmJiB0aGlzLmlzSW5pdGlhbFZhbHVlU2V0O1xyXG4gICAgfVxyXG5cclxuICAgIGZpbHRlcihxdWVyeTogc3RyaW5nLCBldmVudCkge1xyXG4gICAgICAgIC8vIGRvIG5vdCBmaWx0ZXIgcmVhZG9ubHkgZmllbGRzXHJcbiAgICAgICAgaWYgKHRoaXMuaXNSZWFkb25seSgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gZG8gbm90IGZpbHRlciBvbiBzaW1wbGUgdGFiIGZvY3VzIGNoYW5nZVxyXG4gICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSA5KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX3ZhbHVlU2V0ID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHF1ZXJ5ICE9PSBudWxsICYmIHF1ZXJ5Lmxlbmd0aCA+IDAgJiYgcXVlcnkucmVwbGFjZSgvXFxzL2csIFwiXCIpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAvKiBzcGFjZTogYWxsICovXHJcbiAgICAgICAgICAgIHRoaXMuX2ZpbHRlcmVkTGlzdCA9IHRoaXMuX2RhdGEuZmlsdGVyKGZ1bmN0aW9uIChlbnRyeSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVudHJ5LmFjdGl2ZTtcclxuICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHF1ZXJ5ICE9PSBudWxsICYmIHF1ZXJ5ICE9PSBcIlwiKSB7XHJcbiAgICAgICAgICAgIC8qIHNlYXJjaCB0ZXJtOiBmaWx0ZXIgKi9cclxuICAgICAgICAgICAgcXVlcnkgPSBxdWVyeS50cmltKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2ZpbHRlcmVkTGlzdCA9IHRoaXMuX2RhdGEuZmlsdGVyKGZ1bmN0aW9uIChlbnRyeSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFlbnRyeS5hY3RpdmUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlbnRyeU5hbWU6IHN0cmluZyA9IGVudHJ5LnRleHQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoZW50cnlOYW1lLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihxdWVyeS50b0xvd2VyQ2FzZSgpKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX3dvcmRTZWFyY2hFbmFibGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9rZW5zOiBzdHJpbmdbXSA9IGVudHJ5TmFtZS50b0xvd2VyQ2FzZSgpLnNwbGl0KFwiIFwiKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHRva2VuIG9mIHRva2Vucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4uc3RhcnRzV2l0aChxdWVyeS50b0xvd2VyQ2FzZSgpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLyogZW1wdHk6IG5vdGhpbmcgKi9cclxuICAgICAgICAgICAgdGhpcy5jbGVhckZpbHRlcmVkTGlzdCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9maWx0ZXJlZExpc3Quc29ydCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdChpdGVtOiBBdXRvQ29tcGxldGVGaWVsZEVudHJ5KSB7XHJcbiAgICAgICAgdGhpcy5zZXRWYWx1ZShpdGVtLmtleSk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9jdXNMb3N0KCkge1xyXG4gICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLnZhbHVlU2V0KSB7XHJcbiAgICAgICAgICAgICAgICAvLyBmb3JjZSBhbmd1bGFyIHRvIHVwZGF0ZSBxdWVyeS50ZXh0IHZhbHVlXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy52YWx1ZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldERpc3BsYXkobnVsbCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXREaXNwbGF5KHRoaXMudmFsdWVbXCJrZXlcIl0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgMSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldFZhbHVlKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBvbGRWYWx1ZTogc3RyaW5nID0gdGhpcy52YWx1ZTtcclxuXHJcbiAgICAgICAgLy8gYWNjZXB0IGtleSB2YWx1ZXMgYW5kIGNvbXBsZXggb2JqZWN0c1xyXG4gICAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIHZhbHVlW1wia2V5XCJdICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZVtcImtleVwiXTtcclxuICAgICAgICAgICAgdGhpcy5fa2V5VHlwZSA9IHZhbHVlW1wibmFtZVwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fdmFsdWVTZXQgPSB2YWx1ZSAhPSBudWxsO1xyXG4gICAgICAgIHRoaXMuY2xlYXJGaWx0ZXJlZExpc3QoKTtcclxuICAgICAgICBzdXBlci5zZXRWYWx1ZSh2YWx1ZSk7XHJcbiAgICAgICAgdGhpcy5xdWVyeSA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5yZXNldERpc3BsYXkodmFsdWUpO1xyXG4gICAgICAgIC8vIHJlbG9hZCBkZXBlbmRlbnQgYXV0b2NvbXBsZXRlIGZpZWxkc1xyXG4gICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gdGhpcy52YWx1ZSkge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIHRoaXMuZ2V0Rm9ybSgpLmdldEZpZWxkcygpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZmllbGQgaW5zdGFuY2VvZiBBdXRvQ29tcGxldGVGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICgoPEF1dG9Db21wbGV0ZUZpZWxkPmZpZWxkKS5pZCAhPT0gdGhpcy5pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdXRvQ29tcGxldGVGaWVsZCA9IDxBdXRvQ29tcGxldGVGaWVsZD5maWVsZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEtleVV0aWxpdHkudmFyaWFibGVFeGlzdHMoYXV0b0NvbXBsZXRlRmllbGQudXJsLCB0aGlzLmlkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0NvbXBsZXRlRmllbGQubG9hZCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBsb2FkKCkge1xyXG4gICAgICAgIHRoaXMuZGF0YUxvYWRlZCA9IGZhbHNlO1xyXG4gICAgICAgIGxldCB1cmw6IHN0cmluZyA9IHRoaXMudXJsO1xyXG4gICAgICAgIGZvciAoY29uc3QgZmllbGQgb2YgdGhpcy5nZXRGb3JtKCkuZ2V0RmllbGRzKCkpIHtcclxuICAgICAgICAgICAgaWYgKGZpZWxkIGluc3RhbmNlb2YgVmFsdWVGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdmFsdWVGaWVsZCA9IDxWYWx1ZUZpZWxkPGFueT4+ZmllbGQ7XHJcbiAgICAgICAgICAgICAgICB1cmwgPSBLZXlVdGlsaXR5LnJlcGxhY2VWYXJpYWJsZSh1cmwsIHZhbHVlRmllbGQuaWQsIHZhbHVlRmllbGQudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2codXJsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnBhdGhTZXJ2aWNlLnNlcnZlckdldCh0aGlzLmdldEZvcm0oKS5nZXRBcHAoKS5nZXRCYWNrZW5kVXJsKCksIHVybCwgKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkeW5hbWljRGF0YSA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZW50cnkgPSBuZXcgQXV0b0NvbXBsZXRlRmllbGRFbnRyeSgpO1xyXG4gICAgICAgICAgICAgICAgZW50cnkua2V5ID0gaXRlbVtcImtleVwiXVtcImtleVwiXTtcclxuICAgICAgICAgICAgICAgIGVudHJ5LnRleHQgPSBpdGVtW1wibmFtZVwiXTtcclxuICAgICAgICAgICAgICAgIGlmIChpdGVtW1wiYWN0aXZlXCJdICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnRyeS5hY3RpdmUgPSBpdGVtW1wiYWN0aXZlXCJdO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnRyeS5hY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZHluYW1pY0RhdGEucHVzaChlbnRyeSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5kYXRhID0gZHluYW1pY0RhdGE7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YUxvYWRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy52YWx1ZSk7IC8vIGZvcmNlIGRpc3BsYXkgcmVmcmVzaFxyXG4gICAgICAgIH0sIG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXREZXRhaWxCdXR0b25OYW1lKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnZhbHVlID09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmdldFRleHQoXCJOZXdcIikgKyBcIi4uLlwiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5nZXRUZXh0KFwiRGV0YWlsXCIpICsgXCIuLi5cIjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNob3dEZXRhaWxGb3JtKCkge1xyXG4gICAgICAgIGxldCBmb3JtOiBGb3JtID0gbnVsbDtcclxuXHJcbiAgICAgICAgY29uc3QgZm9ybUZ1bmN0aW9uID0gbmV3IEZvcm1GdW5jdGlvbigpO1xyXG4gICAgICAgIGZvcm1GdW5jdGlvbi5zYXZlID0gKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmdldEZvcm0oKS5nZXRBcHAoKS5jbG9zZUN1cnJlbnRGb3JtKCk7XHJcbiAgICAgICAgICAgIGlmIChkYXRhW1wia2V5XCJdICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUoZGF0YVtcImtleVwiXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5sb2FkKCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBmb3JtRnVuY3Rpb24uY2FuY2VsID0gKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmdldEZvcm0oKS5nZXRBcHAoKS5jbG9zZUN1cnJlbnRGb3JtKCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBmb3JtRnVuY3Rpb24uZGVsZXRlID0gKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmdldEZvcm0oKS5nZXRBcHAoKS5jbG9zZUN1cnJlbnRGb3JtKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUobnVsbCk7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZCgpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnZhbHVlID09IG51bGwpIHtcclxuICAgICAgICAgICAgZm9ybSA9IHRoaXMuZ2V0Rm9ybSgpLmdldEFwcCgpLmNyZWF0ZUZvcm0odGhpcy5kZXRhaWxGb3JtLCBudWxsLCBudWxsLCBmb3JtRnVuY3Rpb24sIG51bGwpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZvcm0gPSB0aGlzLmdldEZvcm0oKS5nZXRBcHAoKS5jcmVhdGVGb3JtKHRoaXMuZGV0YWlsRm9ybSwgbmV3IEtleSh0aGlzLnZhbHVlLCB0aGlzLl9rZXlUeXBlKSwgbnVsbCwgZm9ybUZ1bmN0aW9uLCBudWxsKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5mb3JtLmdldEFwcCgpW1wiX2Zvcm1TdGFja1wiXS5wdXNoKGZvcm0pOyAvLyBUT0RPXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsZWFyRmlsdGVyZWRMaXN0KCkge1xyXG4gICAgICAgIHRoaXMuX2ZpbHRlcmVkTGlzdCA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVzZXREaXNwbGF5KHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICAvLyBtdXN0IHdhaXQgd2l0aCBkaXNwbGF5IHVwZGF0ZSB1bnRpbCBkYXRhIGlzIGxvYWRlZFxyXG4gICAgICAgIGNvbnN0IGRpc3BsYXlTZXR0ZXIgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleVZhbHVlID0gdmFsdWU7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5kYXRhTG9hZGVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIndhaXRpbmcuLi5cIik7XHJcbiAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheVNldHRlcigpO1xyXG4gICAgICAgICAgICAgICAgfSwgMjUwKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChrZXlWYWx1ZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayB2YWx1ZSBhZ2FpbiwgbWF5IGhhdmUgY2hhbmdlZCBzaW5jZSByZXNldCB3YXMgdHJpZ2dlcmVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZhbHVlID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkgPSBuZXcgQXV0b0NvbXBsZXRlRmllbGRFbnRyeSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgMSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiB0aGlzLl9kYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlOnRyaXBsZS1lcXVhbHNcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ua2V5ID09IGtleVZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeSA9IGl0ZW07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBkaXNwbGF5U2V0dGVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHF1ZXJ5KCk6IEF1dG9Db21wbGV0ZUZpZWxkRW50cnkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9xdWVyeTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgcXVlcnkodmFsdWU6IEF1dG9Db21wbGV0ZUZpZWxkRW50cnkpIHtcclxuICAgICAgICB0aGlzLl9xdWVyeSA9IHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCBkYXRhKHZhbHVlOiBBdXRvQ29tcGxldGVGaWVsZEVudHJ5W10pIHtcclxuICAgICAgICB0aGlzLl9kYXRhID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGZpbHRlcmVkTGlzdCgpOiBBdXRvQ29tcGxldGVGaWVsZEVudHJ5W10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9maWx0ZXJlZExpc3Q7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IHdvcmRTZWFyY2hFbmFibGVkKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICAgICAgdGhpcy5fd29yZFNlYXJjaEVuYWJsZWQgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdmFsdWVTZXQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlU2V0O1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBkYXRhTG9hZGVkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9kYXRhTG9hZGVkO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCBkYXRhTG9hZGVkKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICAgICAgdGhpcy5fZGF0YUxvYWRlZCA9IHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBkZXRhaWxGb3JtKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RldGFpbEZvcm07XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IGRldGFpbEZvcm0odmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX2RldGFpbEZvcm0gPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdXJsKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3VybDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgdXJsKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLl91cmwgPSB2YWx1ZTtcclxuICAgIH1cclxufVxyXG4iXX0=