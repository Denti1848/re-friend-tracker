import * as tslib_1 from "tslib";
import { Component, Input, Output, ViewChild } from "@angular/core";
import { ValueField } from "../value-field";
import { HttpClient, HttpEvent, HttpEventType, HttpParams, HttpRequest, HttpResponse } from "@angular/common/http";
var FileUploadComponent = /** @class */ (function () {
    function FileUploadComponent(http) {
        this.http = http;
        this.dragActive = false;
    }
    FileUploadComponent.prototype.onDropFile = function (event) {
        this.dragActive = false;
        event.preventDefault();
        this.uploadFile(event.dataTransfer.files);
    };
    FileUploadComponent.prototype.onDragOverFile = function (event) {
        this.dragActive = true;
        event.stopPropagation();
        event.preventDefault();
    };
    FileUploadComponent.prototype.onDragLeave = function () {
        this.dragActive = false;
    };
    FileUploadComponent.prototype.selectFile = function (event) {
        this.uploadFile(event.target.files);
    };
    FileUploadComponent.prototype.uploadFile = function (files) {
        var _this = this;
        if (files.length === 0) {
            console.log("No file selected!");
            return;
        }
        // check if file limit is exceeded
        if (!this.field.checkFileLimit(files.length)) {
            this.resetFileUploadElement();
            return;
        }
        // check file sizes
        if (!this.field.checkFileSize(files)) {
            this.resetFileUploadElement();
            return;
        }
        // upload submitted files
        Array.from(files).forEach(function (file) {
            _this.doUpload(_this.field.getForm().getApp().getBackendUrl() + _this.field.url, file)
                .subscribe(function (event) {
                if (event.type === HttpEventType.UploadProgress) {
                    var percentDone = Math.round(100 * event.loaded / event.total);
                    var uploadFile = _this.field.findCurrentUpload(file.name);
                    if (uploadFile == null) {
                        uploadFile = _this.addNewPathFile(file);
                    }
                    uploadFile.uploadProgress = percentDone;
                }
                else if (event instanceof HttpResponse) {
                    var uploadFile = _this.field.findCurrentUpload(file.name);
                    if (uploadFile == null) {
                        uploadFile = _this.addNewPathFile(file);
                    }
                    var key = new PathFileKey(event.body["key"]["key"], event.body["key"]["name"]);
                    uploadFile.key = key;
                    uploadFile.uploadFinished = true;
                    uploadFile.uploadSuccessful = true;
                    _this.field.updateRequiredStatus();
                }
            }, function (err) {
                console.log("Upload Error:", err);
                var uploadFile = _this.field.findCurrentUpload(file.name);
                if (uploadFile) {
                    uploadFile.sizeString = "Error";
                    uploadFile.uploadFinished = true;
                }
                else {
                    console.log("error: file should exist (" + file.name + ")");
                }
                _this.resetFileUploadElement();
            }, function () {
                _this.resetFileUploadElement();
            });
        });
    };
    FileUploadComponent.prototype.addNewPathFile = function (file) {
        var uploadFile = new PathFile();
        uploadFile.name = file.name;
        uploadFile.size = file.size;
        uploadFile.sizeString = this.field.getReadableFileSizeString(file.size);
        uploadFile.active = true;
        this.field.value.push(uploadFile);
        this.field.sortValues();
        return uploadFile;
    };
    FileUploadComponent.prototype.resetFileUploadElement = function () {
        var count = this.field.value.reduce(function (acc, cur) { return !cur.uploadFinished ? ++acc : acc; }, 0);
        if (count === 0) {
            this.fileInputReference.nativeElement.value = "";
        }
    };
    FileUploadComponent.prototype.doUpload = function (url, file) {
        var formData = new FormData();
        formData.append("upload", file);
        var params = new HttpParams();
        var options = {
            params: params,
            reportProgress: true,
        };
        var req = new HttpRequest("POST", url, formData, options);
        return this.http.request(req); // <any> fixes TS2719
    };
    FileUploadComponent.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    tslib_1.__decorate([
        Input("field"),
        Output("field")
    ], FileUploadComponent.prototype, "field", void 0);
    tslib_1.__decorate([
        ViewChild("fileInput", { static: true })
    ], FileUploadComponent.prototype, "fileInputReference", void 0);
    FileUploadComponent = tslib_1.__decorate([
        Component({
            selector: "path-file-upload",
            template: "<path-form-field-label [label]=\"field.name\" [required]=\"field.required\"></path-form-field-label>\r\n<div [class.col-md-4]=\"field.width == 1\" [class.col-md-10]=\"field.width == 2\" [class.file-upload-drop]=\"dragActive\"\r\n     (drop)=\"onDropFile($event)\" (dragleave)=\"onDragLeave()\" (dragover)=\"onDragOverFile($event)\">\r\n    <table class=\"table\">\r\n        <thead>\r\n        <tr>\r\n            <td class=\"col-md-7\">File Name</td>\r\n            <td class=\"col-md-2\">Size</td>\r\n            <td class=\"col-md-3\"></td>\r\n        </tr>\r\n        </thead>\r\n        <tbody>\r\n        <ng-container *ngFor=\"let file of field.value; let index = index\">\r\n            <tr *ngIf=\"file.active\">\r\n                <td class=\"col-md-7\"><a href=\"#\" (click)=\"field.download(file.key)\">{{file.name}}</a></td>\r\n                <td class=\"col-md-2\">{{file.sizeString}}</td>\r\n                <td class=\"col-md-3\" align=\"right\">\r\n                    <a *ngIf=\"file.uploadFinished\" href=\"#\" (click)=\"field.remove(index, file.key)\">Remove</a>\r\n                    <div *ngIf=\"!file.uploadFinished\" class=\"progress\">\r\n                        <div class=\"progress-bar\" role=\"progressbar\" [style.width.%]=\"file.uploadProgress\"\r\n                             [attr.aria-valuenow]=\"file.uploadProgress\" aria-valuemin=\"0\" aria-valuemax=\"100\">\r\n                            <span class=\"sr-only\">{{file.uploadProgress}}% Complete</span>\r\n                        </div>\r\n                    </div>\r\n                </td>\r\n            </tr>\r\n        </ng-container>\r\n        </tbody>\r\n    </table>\r\n    <div class=\"form-group\">\r\n        <input type=\"file\" class=\"form-control-file\" (change)=\"selectFile($event)\" placeholder=\"Upload file\"\r\n               [multiple]=\"field.multiple\" accept=\"{{field.acceptedFileTypes.join(', ')}}\"\r\n               [disabled]=\"field.isReadonly()\"\r\n               [required]=\"field.fileUploadRequired\" #fileInput>\r\n    </div>\r\n</div>\r\n"
        })
    ], FileUploadComponent);
    return FileUploadComponent;
}());
export { FileUploadComponent };
var FileUploadField = /** @class */ (function (_super) {
    tslib_1.__extends(FileUploadField, _super);
    function FileUploadField(form, translationService) {
        var _this = _super.call(this, form, translationService) || this;
        _this._multiple = true;
        _this._acceptedFileTypes = [];
        _this._fileLimit = 0;
        _this._singleFileSizeLimit = 0;
        _this._allFilesSizeLimit = 0;
        _this.value = [];
        _this._acceptedFileTypes.push("*.*");
        _this.updateRequiredStatus();
        return _this;
    }
    FileUploadField.prototype.setValue = function (value) {
        var e_1, _a;
        var files = [];
        try {
            for (var value_1 = tslib_1.__values(value), value_1_1 = value_1.next(); !value_1_1.done; value_1_1 = value_1.next()) {
                var item = value_1_1.value;
                var file = Object.assign(new PathFile(), item);
                file.key = Object.assign(new PathFileKey(null, null), item.key);
                files.push(file);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (value_1_1 && !value_1_1.done && (_a = value_1.return)) _a.call(value_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        this.sortValues();
        _super.prototype.setValue.call(this, files);
        this.updateRequiredStatus();
    };
    FileUploadField.prototype.sortValues = function () {
        this.value.sort(function (a, b) { return a.name.localeCompare(b.name); });
    };
    Object.defineProperty(FileUploadField.prototype, "url", {
        get: function () {
            return this._url;
        },
        set: function (value) {
            this._url = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FileUploadField.prototype, "multiple", {
        get: function () {
            return this._multiple;
        },
        set: function (value) {
            this._multiple = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FileUploadField.prototype, "acceptedFileTypes", {
        get: function () {
            return this._acceptedFileTypes;
        },
        set: function (value) {
            this._acceptedFileTypes = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FileUploadField.prototype, "fileUploadRequired", {
        get: function () {
            return this._fileUploadRequired;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FileUploadField.prototype, "fileLimit", {
        get: function () {
            return this._fileLimit;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FileUploadField.prototype, "singleFileSizeLimit", {
        get: function () {
            return this._singleFileSizeLimit;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FileUploadField.prototype, "allFilesSizeLimit", {
        get: function () {
            return this._allFilesSizeLimit;
        },
        enumerable: true,
        configurable: true
    });
    FileUploadField.prototype.remove = function (index, key) {
        if (key) {
            var file = this.find(key);
            if (file) {
                file.active = false;
            }
            this.updateRequiredStatus();
        }
        else {
            this.value.splice(index, 1);
        }
    };
    FileUploadField.prototype.find = function (key) {
        var e_2, _a;
        try {
            for (var _b = tslib_1.__values(this.value), _c = _b.next(); !_c.done; _c = _b.next()) {
                var file = _c.value;
                if (file.key.equals(key)) {
                    return file;
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return null;
    };
    FileUploadField.prototype.findCurrentUpload = function (name) {
        var e_3, _a;
        try {
            for (var _b = tslib_1.__values(this.value), _c = _b.next(); !_c.done; _c = _b.next()) {
                var file = _c.value;
                if (file.name === name && !file.uploadFinished) {
                    return file;
                }
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_3) throw e_3.error; }
        }
        return null;
    };
    FileUploadField.prototype.updateRequiredStatus = function () {
        var uploadInProgressCount = 0;
        var uploadSuccessfulCount = 0;
        this.value.forEach(function (file) {
            if (file.active && !file.uploadFinished) {
                uploadInProgressCount++;
            }
            if (file.active && file.uploadSuccessful) {
                uploadSuccessfulCount++;
            }
        });
        var newStatus = false;
        if (uploadInProgressCount > 0) {
            // always required if upload in progress
            newStatus = true;
        }
        else if (this.required && uploadSuccessfulCount <= 0) {
            newStatus = true;
        }
        this._fileUploadRequired = newStatus;
    };
    FileUploadField.prototype.checkFileLimit = function (newFilesLength) {
        var activeFileCount = 0;
        this.value.forEach(function (file) {
            if (file.active) {
                activeFileCount++;
            }
        });
        if (this.fileLimit > 0 && ((activeFileCount + newFilesLength) > this.fileLimit)) {
            var message = this.translationService.getText("FileLimitMessage", String(this.fileLimit));
            this.getForm().getApp().yesNo(message, function () { }, function () { });
            return false;
        }
        return true;
    };
    FileUploadField.prototype.checkFileSize = function (files) {
        var e_4, _a;
        if (this._singleFileSizeLimit || this._allFilesSizeLimit) {
            // check single file limit
            var sizeSum_1 = 0;
            var fileArray = Array.from(files);
            try {
                for (var fileArray_1 = tslib_1.__values(fileArray), fileArray_1_1 = fileArray_1.next(); !fileArray_1_1.done; fileArray_1_1 = fileArray_1.next()) {
                    var file = fileArray_1_1.value;
                    sizeSum_1 += file.size;
                    if (this._singleFileSizeLimit > 0 && file.size > this._singleFileSizeLimit) {
                        var message = this.translationService.getText("FileSingleSizeMessage", this.getReadableFileSizeString(this._singleFileSizeLimit));
                        this.getForm().getApp().yesNo(message, function () { }, function () { });
                        return false;
                    }
                }
            }
            catch (e_4_1) { e_4 = { error: e_4_1 }; }
            finally {
                try {
                    if (fileArray_1_1 && !fileArray_1_1.done && (_a = fileArray_1.return)) _a.call(fileArray_1);
                }
                finally { if (e_4) throw e_4.error; }
            }
            // check sum limit
            if (this._allFilesSizeLimit > 0) {
                this.value.forEach(function (file) {
                    if (file.active) {
                        sizeSum_1 += file.size;
                    }
                });
                if (this._allFilesSizeLimit > 0 && sizeSum_1 > this._allFilesSizeLimit) {
                    var message = this.translationService.getText("FileAllSizeMessage", this.getReadableFileSizeString(this._allFilesSizeLimit));
                    this.getForm().getApp().yesNo(message, function () { }, function () { });
                    return false;
                }
            }
        }
        return true;
    };
    FileUploadField.prototype.getReadableFileSizeString = function (byteSize) {
        var i = -1;
        var byteUnits = [" kB", " MB", " GB", " TB", " PB", " EB", " ZB", " YB"];
        do {
            byteSize = byteSize / 1024;
            i++;
        } while (byteSize > 1024);
        return Math.max(byteSize, 0.1).toFixed(1) + byteUnits[i];
    };
    FileUploadField.prototype.download = function (key) {
        window.location.assign(this.getForm().getApp().getBackendUrl() + this.url + "/" + key.key);
    };
    FileUploadField.prototype.fromJson = function (modelFormField) {
        _super.prototype.fromJson.call(this, modelFormField);
        this.type = "fileUpload";
        if (modelFormField["url"]) {
            this.url = modelFormField["url"];
        }
        if (modelFormField["multiple"] != null) {
            this.multiple = modelFormField["multiple"];
        }
        if (modelFormField["acceptedFileTypes"]) {
            this.acceptedFileTypes = modelFormField["acceptedFileTypes"];
        }
        if (modelFormField["fileLimit"]) {
            this._fileLimit = modelFormField["fileLimit"];
        }
        if (modelFormField["singleFileSizeLimit"]) {
            this._singleFileSizeLimit = modelFormField["singleFileSizeLimit"];
        }
        if (modelFormField["allFilesSizeLimit"]) {
            this._allFilesSizeLimit = modelFormField["allFilesSizeLimit"];
        }
        this.updateRequiredStatus();
    };
    return FileUploadField;
}(ValueField));
export { FileUploadField };
var PathFile = /** @class */ (function () {
    function PathFile() {
        this.uploadFinished = false;
        this.uploadSuccessful = false;
        this.uploadProgress = 0;
        this.size = 0;
    }
    return PathFile;
}());
export { PathFile };
// TODO unify with list key
// tslint:disable:max-classes-per-file
var PathFileKey = /** @class */ (function () {
    function PathFileKey(key, name) {
        this.key = key;
        this.name = name;
    }
    PathFileKey.prototype.equals = function (otherKey) {
        if (otherKey != null &&
            otherKey.name &&
            otherKey.key &&
            this.name &&
            this.key &&
            otherKey.name === this.name &&
            otherKey.key === this.key) {
            return true;
        }
        return false;
    };
    return PathFileKey;
}());
export { PathFileKey };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vcGF0aC1mcmFtZXdvcmsvIiwic291cmNlcyI6WyJwYXRoLWZyYW1ld29yay9mb3JtL2ZpZWxkL2ZpbGUtdXBsb2FkL2ZpbGUtdXBsb2FkLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBYyxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUM5RSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFTakg7SUFTSSw2QkFBb0IsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUZwQyxlQUFVLEdBQUcsS0FBSyxDQUFDO0lBR25CLENBQUM7SUFFRCx3Q0FBVSxHQUFWLFVBQVcsS0FBZ0I7UUFDdkIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDeEIsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQsNENBQWMsR0FBZCxVQUFlLEtBQUs7UUFDaEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDdkIsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3hCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQseUNBQVcsR0FBWDtRQUNJLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQzVCLENBQUM7SUFFRCx3Q0FBVSxHQUFWLFVBQVcsS0FBSztRQUNaLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFD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QUFJLFFBQVEsSUFBSSxJQUFJO1lBQ2hCLFFBQVEsQ0FBQyxJQUFJO1lBQ2IsUUFBUSxDQUFDLEdBQUc7WUFDWixJQUFJLENBQUMsSUFBSTtZQUNULElBQUksQ0FBQyxHQUFHO1lBQ1IsUUFBUSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsSUFBSTtZQUMzQixRQUFRLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDM0IsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFTCxrQkFBQztBQUFELENBQUMsQUF0QkQsSUFzQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5wdXQsIE91dHB1dCwgVmlld0NoaWxkfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQge1ZhbHVlRmllbGR9IGZyb20gXCIuLi92YWx1ZS1maWVsZFwiO1xyXG5pbXBvcnQge0h0dHBDbGllbnQsIEh0dHBFdmVudCwgSHR0cEV2ZW50VHlwZSwgSHR0cFBhcmFtcywgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZX0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHtJRm9ybX0gZnJvbSBcIi4uLy4uLy4uL3BhdGhpbnRlcmZhY2VcIjtcclxuaW1wb3J0IHtUcmFuc2xhdGlvblNlcnZpY2V9IGZyb20gXCIuLi8uLi8uLi9zZXJ2aWNlL3RyYW5zbGF0aW9uLnNlcnZpY2VcIjtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6IFwicGF0aC1maWxlLXVwbG9hZFwiLFxyXG4gICAgdGVtcGxhdGVVcmw6IFwiZmlsZS11cGxvYWQuY29tcG9uZW50Lmh0bWxcIlxyXG59KVxyXG5leHBvcnQgY2xhc3MgRmlsZVVwbG9hZENvbXBvbmVudCB7XHJcbiAgICBASW5wdXQoXCJmaWVsZFwiKVxyXG4gICAgQE91dHB1dChcImZpZWxkXCIpXHJcbiAgICBmaWVsZDogRmlsZVVwbG9hZEZpZWxkO1xyXG5cclxuICAgIEBWaWV3Q2hpbGQoXCJmaWxlSW5wdXRcIiwge3N0YXRpYzogdHJ1ZX0pXHJcbiAgICBmaWxlSW5wdXRSZWZlcmVuY2U6IEVsZW1lbnRSZWY7XHJcbiAgICBkcmFnQWN0aXZlID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7XHJcbiAgICB9XHJcblxyXG4gICAgb25Ecm9wRmlsZShldmVudDogRHJhZ0V2ZW50KSB7XHJcbiAgICAgICAgdGhpcy5kcmFnQWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICB0aGlzLnVwbG9hZEZpbGUoZXZlbnQuZGF0YVRyYW5zZmVyLmZpbGVzKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkRyYWdPdmVyRmlsZShldmVudCkge1xyXG4gICAgICAgIHRoaXMuZHJhZ0FjdGl2ZSA9IHRydWU7XHJcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkRyYWdMZWF2ZSgpIHtcclxuICAgICAgICB0aGlzLmRyYWdBY3RpdmUgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RGaWxlKGV2ZW50KSB7XHJcbiAgICAgICAgdGhpcy51cGxvYWRGaWxlKGV2ZW50LnRhcmdldC5maWxlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBsb2FkRmlsZShmaWxlczogRmlsZUxpc3QpIHtcclxuICAgICAgICBpZiAoZmlsZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTm8gZmlsZSBzZWxlY3RlZCFcIik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGNoZWNrIGlmIGZpbGUgbGltaXQgaXMgZXhjZWVkZWRcclxuICAgICAgICBpZiAoIXRoaXMuZmllbGQuY2hlY2tGaWxlTGltaXQoZmlsZXMubGVuZ3RoKSkge1xyXG4gICAgICAgICAgICB0aGlzLnJlc2V0RmlsZVVwbG9hZEVsZW1lbnQoKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjaGVjayBmaWxlIHNpemVzXHJcbiAgICAgICAgaWYgKCF0aGlzLmZpZWxkLmNoZWNrRmlsZVNpemUoZmlsZXMpKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVzZXRGaWxlVXBsb2FkRWxlbWVudCgpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHVwbG9hZCBzdWJtaXR0ZWQgZmlsZXNcclxuICAgICAgICBBcnJheS5mcm9tKGZpbGVzKS5mb3JFYWNoKChmaWxlKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZG9VcGxvYWQodGhpcy5maWVsZC5nZXRGb3JtKCkuZ2V0QXBwKCkuZ2V0QmFja2VuZFVybCgpICsgdGhpcy5maWVsZC51cmwsIGZpbGUpXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09IEh0dHBFdmVudFR5cGUuVXBsb2FkUHJvZ3Jlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlcmNlbnREb25lOiBudW1iZXIgPSBNYXRoLnJvdW5kKDEwMCAqIGV2ZW50LmxvYWRlZCAvIGV2ZW50LnRvdGFsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCB1cGxvYWRGaWxlID0gdGhpcy5maWVsZC5maW5kQ3VycmVudFVwbG9hZChmaWxlLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVwbG9hZEZpbGUgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUgPSB0aGlzLmFkZE5ld1BhdGhGaWxlKGZpbGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS51cGxvYWRQcm9ncmVzcyA9IHBlcmNlbnREb25lO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudCBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHVwbG9hZEZpbGUgPSB0aGlzLmZpZWxkLmZpbmRDdXJyZW50VXBsb2FkKGZpbGUubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodXBsb2FkRmlsZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZSA9IHRoaXMuYWRkTmV3UGF0aEZpbGUoZmlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXk6IFBhdGhGaWxlS2V5ID0gbmV3IFBhdGhGaWxlS2V5KGV2ZW50LmJvZHlbXCJrZXlcIl1bXCJrZXlcIl0sIGV2ZW50LmJvZHlbXCJrZXlcIl1bXCJuYW1lXCJdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUua2V5ID0ga2V5O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS51cGxvYWRGaW5pc2hlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnVwbG9hZFN1Y2Nlc3NmdWwgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5maWVsZC51cGRhdGVSZXF1aXJlZFN0YXR1cygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVXBsb2FkIEVycm9yOlwiLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1cGxvYWRGaWxlID0gdGhpcy5maWVsZC5maW5kQ3VycmVudFVwbG9hZChmaWxlLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodXBsb2FkRmlsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS5zaXplU3RyaW5nID0gXCJFcnJvclwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS51cGxvYWRGaW5pc2hlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImVycm9yOiBmaWxlIHNob3VsZCBleGlzdCAoXCIgKyBmaWxlLm5hbWUgKyBcIilcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldEZpbGVVcGxvYWRFbGVtZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc2V0RmlsZVVwbG9hZEVsZW1lbnQoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWRkTmV3UGF0aEZpbGUoZmlsZSk6IFBhdGhGaWxlIHtcclxuICAgICAgICBjb25zdCB1cGxvYWRGaWxlID0gbmV3IFBhdGhGaWxlKCk7XHJcbiAgICAgICAgdXBsb2FkRmlsZS5uYW1lID0gZmlsZS5uYW1lO1xyXG4gICAgICAgIHVwbG9hZEZpbGUuc2l6ZSA9IGZpbGUuc2l6ZTtcclxuICAgICAgICB1cGxvYWRGaWxlLnNpemVTdHJpbmcgPSB0aGlzLmZpZWxkLmdldFJlYWRhYmxlRmlsZVNpemVTdHJpbmcoZmlsZS5zaXplKTtcclxuICAgICAgICB1cGxvYWRGaWxlLmFjdGl2ZSA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5maWVsZC52YWx1ZS5wdXNoKHVwbG9hZEZpbGUpO1xyXG4gICAgICAgIHRoaXMuZmllbGQuc29ydFZhbHVlcygpO1xyXG4gICAgICAgIHJldHVybiB1cGxvYWRGaWxlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVzZXRGaWxlVXBsb2FkRWxlbWVudCgpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBjb3VudCA9IHRoaXMuZmllbGQudmFsdWUucmVkdWNlKChhY2MsIGN1cikgPT4gIWN1ci51cGxvYWRGaW5pc2hlZCA/ICsrYWNjIDogYWNjLCAwKTtcclxuICAgICAgICBpZiAoY291bnQgPT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5maWxlSW5wdXRSZWZlcmVuY2UubmF0aXZlRWxlbWVudC52YWx1ZSA9IFwiXCI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZG9VcGxvYWQodXJsOiBzdHJpbmcsIGZpbGU6IEZpbGUpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XHJcblxyXG4gICAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwidXBsb2FkXCIsIGZpbGUpO1xyXG5cclxuICAgICAgICBjb25zdCBwYXJhbXMgPSBuZXcgSHR0cFBhcmFtcygpO1xyXG5cclxuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgICBwYXJhbXM6IHBhcmFtcyxcclxuICAgICAgICAgICAgcmVwb3J0UHJvZ3Jlc3M6IHRydWUsXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgcmVxID0gbmV3IEh0dHBSZXF1ZXN0KFwiUE9TVFwiLCB1cmwsIGZvcm1EYXRhLCBvcHRpb25zKTtcclxuICAgICAgICByZXR1cm4gPGFueT50aGlzLmh0dHAucmVxdWVzdChyZXEpOyAvLyA8YW55PiBmaXhlcyBUUzI3MTlcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBGaWxlVXBsb2FkRmllbGQgZXh0ZW5kcyBWYWx1ZUZpZWxkPFBhdGhGaWxlW10+IHtcclxuXHJcbiAgICBwcml2YXRlIF91cmw6IHN0cmluZztcclxuICAgIHByaXZhdGUgX211bHRpcGxlID0gdHJ1ZTtcclxuICAgIHByaXZhdGUgX2FjY2VwdGVkRmlsZVR5cGVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBfZmlsZVVwbG9hZFJlcXVpcmVkOiBib29sZWFuO1xyXG4gICAgcHJpdmF0ZSBfZmlsZUxpbWl0ID0gMDtcclxuICAgIHByaXZhdGUgX3NpbmdsZUZpbGVTaXplTGltaXQgPSAwO1xyXG4gICAgcHJpdmF0ZSBfYWxsRmlsZXNTaXplTGltaXQgPSAwO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGZvcm06IElGb3JtLCB0cmFuc2xhdGlvblNlcnZpY2U6IFRyYW5zbGF0aW9uU2VydmljZSkge1xyXG4gICAgICAgIHN1cGVyKGZvcm0sIHRyYW5zbGF0aW9uU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy52YWx1ZSA9IFtdO1xyXG4gICAgICAgIHRoaXMuX2FjY2VwdGVkRmlsZVR5cGVzLnB1c2goXCIqLipcIik7XHJcbiAgICAgICAgdGhpcy51cGRhdGVSZXF1aXJlZFN0YXR1cygpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFZhbHVlKHZhbHVlOiBQYXRoRmlsZVtdKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgZmlsZXM6IFBhdGhGaWxlW10gPSBbXTtcclxuICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpIHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZSA9IE9iamVjdC5hc3NpZ24obmV3IFBhdGhGaWxlKCksIGl0ZW0pO1xyXG4gICAgICAgICAgICBmaWxlLmtleSA9IE9iamVjdC5hc3NpZ24obmV3IFBhdGhGaWxlS2V5KG51bGwsIG51bGwpLCBpdGVtLmtleSk7XHJcbiAgICAgICAgICAgIGZpbGVzLnB1c2goZmlsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc29ydFZhbHVlcygpO1xyXG4gICAgICAgIHN1cGVyLnNldFZhbHVlKGZpbGVzKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZVJlcXVpcmVkU3RhdHVzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNvcnRWYWx1ZXMoKSB7XHJcbiAgICAgICAgdGhpcy52YWx1ZS5zb3J0KChhLCBiKSA9PiBhLm5hbWUubG9jYWxlQ29tcGFyZShiLm5hbWUpKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdXJsKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3VybDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgdXJsKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLl91cmwgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbXVsdGlwbGUoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX211bHRpcGxlO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCBtdWx0aXBsZSh2YWx1ZTogYm9vbGVhbikge1xyXG4gICAgICAgIHRoaXMuX211bHRpcGxlID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGFjY2VwdGVkRmlsZVR5cGVzKCk6IHN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fYWNjZXB0ZWRGaWxlVHlwZXM7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IGFjY2VwdGVkRmlsZVR5cGVzKHZhbHVlOiBzdHJpbmdbXSkge1xyXG4gICAgICAgIHRoaXMuX2FjY2VwdGVkRmlsZVR5cGVzID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGZpbGVVcGxvYWRSZXF1aXJlZCgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZmlsZVVwbG9hZFJlcXVpcmVkO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBmaWxlTGltaXQoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZmlsZUxpbWl0O1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBzaW5nbGVGaWxlU2l6ZUxpbWl0KCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NpbmdsZUZpbGVTaXplTGltaXQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGFsbEZpbGVzU2l6ZUxpbWl0KCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FsbEZpbGVzU2l6ZUxpbWl0O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZW1vdmUoaW5kZXg6IG51bWJlciwga2V5OiBQYXRoRmlsZUtleSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChrZXkpIHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZTogUGF0aEZpbGUgPSB0aGlzLmZpbmQoa2V5KTtcclxuICAgICAgICAgICAgaWYgKGZpbGUpIHtcclxuICAgICAgICAgICAgICAgIGZpbGUuYWN0aXZlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51cGRhdGVSZXF1aXJlZFN0YXR1cygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudmFsdWUuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGZpbmQoa2V5OiBQYXRoRmlsZUtleSk6IFBhdGhGaWxlIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgdGhpcy52YWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAoZmlsZS5rZXkuZXF1YWxzKGtleSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaWxlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmaW5kQ3VycmVudFVwbG9hZChuYW1lOiBzdHJpbmcpOiBQYXRoRmlsZSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIHRoaXMudmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKGZpbGUubmFtZSA9PT0gbmFtZSAmJiAhZmlsZS51cGxvYWRGaW5pc2hlZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHVwZGF0ZVJlcXVpcmVkU3RhdHVzKCkge1xyXG4gICAgICAgIGxldCB1cGxvYWRJblByb2dyZXNzQ291bnQgPSAwO1xyXG4gICAgICAgIGxldCB1cGxvYWRTdWNjZXNzZnVsQ291bnQgPSAwO1xyXG4gICAgICAgIHRoaXMudmFsdWUuZm9yRWFjaCgoZmlsZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZmlsZS5hY3RpdmUgJiYgIWZpbGUudXBsb2FkRmluaXNoZWQpIHtcclxuICAgICAgICAgICAgICAgIHVwbG9hZEluUHJvZ3Jlc3NDb3VudCsrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChmaWxlLmFjdGl2ZSAmJiBmaWxlLnVwbG9hZFN1Y2Nlc3NmdWwpIHtcclxuICAgICAgICAgICAgICAgIHVwbG9hZFN1Y2Nlc3NmdWxDb3VudCsrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGV0IG5ld1N0YXR1cyA9IGZhbHNlO1xyXG4gICAgICAgIGlmICh1cGxvYWRJblByb2dyZXNzQ291bnQgPiAwKSB7XHJcbiAgICAgICAgICAgIC8vIGFsd2F5cyByZXF1aXJlZCBpZiB1cGxvYWQgaW4gcHJvZ3Jlc3NcclxuICAgICAgICAgICAgbmV3U3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmVxdWlyZWQgJiYgdXBsb2FkU3VjY2Vzc2Z1bENvdW50IDw9IDApIHtcclxuICAgICAgICAgICAgbmV3U3RhdHVzID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fZmlsZVVwbG9hZFJlcXVpcmVkID0gbmV3U3RhdHVzO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjaGVja0ZpbGVMaW1pdChuZXdGaWxlc0xlbmd0aDogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICAgICAgbGV0IGFjdGl2ZUZpbGVDb3VudCA9IDA7XHJcbiAgICAgICAgdGhpcy52YWx1ZS5mb3JFYWNoKChmaWxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChmaWxlLmFjdGl2ZSkge1xyXG4gICAgICAgICAgICAgICAgYWN0aXZlRmlsZUNvdW50Kys7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAodGhpcy5maWxlTGltaXQgPiAwICYmICgoYWN0aXZlRmlsZUNvdW50ICsgbmV3RmlsZXNMZW5ndGgpID4gdGhpcy5maWxlTGltaXQpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5nZXRUZXh0KFwiRmlsZUxpbWl0TWVzc2FnZVwiLCBTdHJpbmcodGhpcy5maWxlTGltaXQpKTtcclxuICAgICAgICAgICAgdGhpcy5nZXRGb3JtKCkuZ2V0QXBwKCkueWVzTm8obWVzc2FnZSwgKCkgPT4ge30sICgpID0+IHt9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2hlY2tGaWxlU2l6ZShmaWxlczogRmlsZUxpc3QpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAodGhpcy5fc2luZ2xlRmlsZVNpemVMaW1pdCB8fCB0aGlzLl9hbGxGaWxlc1NpemVMaW1pdCkge1xyXG4gICAgICAgICAgICAvLyBjaGVjayBzaW5nbGUgZmlsZSBsaW1pdFxyXG4gICAgICAgICAgICBsZXQgc2l6ZVN1bSA9IDA7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbGVBcnJheSA9IEFycmF5LmZyb20oZmlsZXMpO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZUFycmF5KSB7XHJcbiAgICAgICAgICAgICAgICBzaXplU3VtICs9IGZpbGUuc2l6ZTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zaW5nbGVGaWxlU2l6ZUxpbWl0ID4gMCAmJiBmaWxlLnNpemUgPiB0aGlzLl9zaW5nbGVGaWxlU2l6ZUxpbWl0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLmdldFRleHQoXCJGaWxlU2luZ2xlU2l6ZU1lc3NhZ2VcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRSZWFkYWJsZUZpbGVTaXplU3RyaW5nKHRoaXMuX3NpbmdsZUZpbGVTaXplTGltaXQpKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldEZvcm0oKS5nZXRBcHAoKS55ZXNObyhtZXNzYWdlLCAoKSA9PiB7fSwgKCkgPT4ge30pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBjaGVjayBzdW0gbGltaXRcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2FsbEZpbGVzU2l6ZUxpbWl0ID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy52YWx1ZS5mb3JFYWNoKChmaWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGUuYWN0aXZlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpemVTdW0gKz0gZmlsZS5zaXplO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2FsbEZpbGVzU2l6ZUxpbWl0ID4gMCAmJiBzaXplU3VtID4gdGhpcy5fYWxsRmlsZXNTaXplTGltaXQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy50cmFuc2xhdGlvblNlcnZpY2UuZ2V0VGV4dChcIkZpbGVBbGxTaXplTWVzc2FnZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFJlYWRhYmxlRmlsZVNpemVTdHJpbmcodGhpcy5fYWxsRmlsZXNTaXplTGltaXQpKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldEZvcm0oKS5nZXRBcHAoKS55ZXNObyhtZXNzYWdlLCAoKSA9PiB7fSwgKCkgPT4ge30pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0UmVhZGFibGVGaWxlU2l6ZVN0cmluZyhieXRlU2l6ZTogbnVtYmVyKTogc3RyaW5nIHtcclxuICAgICAgICBsZXQgaSA9IC0xO1xyXG4gICAgICAgIGNvbnN0IGJ5dGVVbml0cyA9IFtcIiBrQlwiLCBcIiBNQlwiLCBcIiBHQlwiLCBcIiBUQlwiLCBcIiBQQlwiLCBcIiBFQlwiLCBcIiBaQlwiLCBcIiBZQlwiXTtcclxuICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgIGJ5dGVTaXplID0gYnl0ZVNpemUgLyAxMDI0O1xyXG4gICAgICAgICAgICBpKys7XHJcbiAgICAgICAgfSB3aGlsZSAoYnl0ZVNpemUgPiAxMDI0KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGJ5dGVTaXplLCAwLjEpLnRvRml4ZWQoMSkgKyBieXRlVW5pdHNbaV07XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGRvd25sb2FkKGtleTogUGF0aEZpbGVLZXkpIHtcclxuICAgICAgICB3aW5kb3cubG9jYXRpb24uYXNzaWduKHRoaXMuZ2V0Rm9ybSgpLmdldEFwcCgpLmdldEJhY2tlbmRVcmwoKSArIHRoaXMudXJsICsgXCIvXCIgKyBrZXkua2V5KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZnJvbUpzb24obW9kZWxGb3JtRmllbGQpIHtcclxuICAgICAgICBzdXBlci5mcm9tSnNvbihtb2RlbEZvcm1GaWVsZCk7XHJcbiAgICAgICAgdGhpcy50eXBlID0gXCJmaWxlVXBsb2FkXCI7XHJcbiAgICAgICAgaWYgKG1vZGVsRm9ybUZpZWxkW1widXJsXCJdKSB7XHJcbiAgICAgICAgICAgIHRoaXMudXJsID0gbW9kZWxGb3JtRmllbGRbXCJ1cmxcIl07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbEZvcm1GaWVsZFtcIm11bHRpcGxlXCJdICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5tdWx0aXBsZSA9IG1vZGVsRm9ybUZpZWxkW1wibXVsdGlwbGVcIl07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbEZvcm1GaWVsZFtcImFjY2VwdGVkRmlsZVR5cGVzXCJdKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWNjZXB0ZWRGaWxlVHlwZXMgPSBtb2RlbEZvcm1GaWVsZFtcImFjY2VwdGVkRmlsZVR5cGVzXCJdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobW9kZWxGb3JtRmllbGRbXCJmaWxlTGltaXRcIl0pIHtcclxuICAgICAgICAgICAgdGhpcy5fZmlsZUxpbWl0ID0gbW9kZWxGb3JtRmllbGRbXCJmaWxlTGltaXRcIl07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2RlbEZvcm1GaWVsZFtcInNpbmdsZUZpbGVTaXplTGltaXRcIl0pIHtcclxuICAgICAgICAgICAgdGhpcy5fc2luZ2xlRmlsZVNpemVMaW1pdCA9IG1vZGVsRm9ybUZpZWxkW1wic2luZ2xlRmlsZVNpemVMaW1pdFwiXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vZGVsRm9ybUZpZWxkW1wiYWxsRmlsZXNTaXplTGltaXRcIl0pIHtcclxuICAgICAgICAgICAgdGhpcy5fYWxsRmlsZXNTaXplTGltaXQgPSBtb2RlbEZvcm1GaWVsZFtcImFsbEZpbGVzU2l6ZUxpbWl0XCJdO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnVwZGF0ZVJlcXVpcmVkU3RhdHVzKCk7XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUGF0aEZpbGUge1xyXG4gICAgYWN0aXZlOiBib29sZWFuOyAvLyBmaWxlIGRlbGV0ZWQ6IGFjdGl2ZSA9PT0gZmFsc2VcclxuICAgIHVwbG9hZEZpbmlzaGVkID0gZmFsc2U7XHJcbiAgICB1cGxvYWRTdWNjZXNzZnVsID0gZmFsc2U7XHJcbiAgICB1cGxvYWRQcm9ncmVzcyA9IDA7XHJcbiAgICBuYW1lOiBzdHJpbmc7XHJcbiAgICBzaXplU3RyaW5nOiBzdHJpbmc7XHJcbiAgICBzaXplID0gMDtcclxuICAgIGtleTogUGF0aEZpbGVLZXk7XHJcbn1cclxuXHJcbi8vIFRPRE8gdW5pZnkgd2l0aCBsaXN0IGtleVxyXG4vLyB0c2xpbnQ6ZGlzYWJsZTptYXgtY2xhc3Nlcy1wZXItZmlsZVxyXG5leHBvcnQgY2xhc3MgUGF0aEZpbGVLZXkge1xyXG4gICAga2V5OiBzdHJpbmc7XHJcbiAgICBuYW1lOiBhbnk7XHJcblxyXG4gICAgY29uc3RydWN0b3Ioa2V5OiBzdHJpbmcsIG5hbWU6IGFueSkge1xyXG4gICAgICAgIHRoaXMua2V5ID0ga2V5O1xyXG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGVxdWFscyhvdGhlcktleTogUGF0aEZpbGVLZXkpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAob3RoZXJLZXkgIT0gbnVsbCAmJlxyXG4gICAgICAgICAgICBvdGhlcktleS5uYW1lICYmXHJcbiAgICAgICAgICAgIG90aGVyS2V5LmtleSAmJlxyXG4gICAgICAgICAgICB0aGlzLm5hbWUgJiZcclxuICAgICAgICAgICAgdGhpcy5rZXkgJiZcclxuICAgICAgICAgICAgb3RoZXJLZXkubmFtZSA9PT0gdGhpcy5uYW1lICYmXHJcbiAgICAgICAgICAgIG90aGVyS2V5LmtleSA9PT0gdGhpcy5rZXkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbn1cclxuIl19