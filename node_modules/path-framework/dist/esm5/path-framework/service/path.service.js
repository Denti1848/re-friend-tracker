import * as tslib_1 from "tslib";
import { Injectable, Inject } from "@angular/core";
import { TranslationService } from "./translation.service";
import { HttpClient, HttpHeaders } from "@angular/common/http";
var PathService = /** @class */ (function () {
    function PathService(http, translationService) {
        this.http = http;
        this.translationService = translationService;
        this._alertStack = [];
        this._requestCount = 0;
    }
    PathService.prototype.isLoading = function () {
        return this._requestCount > 0;
    };
    PathService.prototype.showLoading = function () {
        var _this = this;
        window.setTimeout(function () {
            _this._requestCount++;
        }, 1);
    };
    PathService.prototype.hideLoading = function () {
        var _this = this;
        window.setTimeout(function () {
            _this._requestCount--;
        }, 1);
    };
    PathService.prototype.serverGet = function (server, url, processor, errorHandler) {
        var _this = this;
        if (url != null) {
            // fetch json data from url
            this.showLoading();
            this.http.get(server + url, { observe: "response", headers: this.appendHeaders() })
                .subscribe(function (data) {
                var jwt = data.headers.get("Authorization");
                if (jwt != null && jwt !== "") {
                    sessionStorage.setItem("pathAppId", data.headers.get("Authorization"));
                }
                else {
                    sessionStorage.removeItem("pathAppId");
                }
                processor(data.body);
            }, function (err) {
                if (errorHandler == null) {
                    _this.handleError(err);
                }
                else {
                    errorHandler(err);
                }
            }, function () {
                _this.hideLoading();
                console.log("server GET to " + server + url + " finished");
            });
        }
        else {
            // no url provided, therefore call processor without data
            processor(null);
        }
    };
    PathService.prototype.serverPost = function (server, url, data, processor, errorHandler) {
        var _this = this;
        if (url != null) {
            this.showLoading();
            this.http.post(server + url, data, { observe: "response", headers: this.appendHeaders() })
                .subscribe(function (responseData) {
                sessionStorage.setItem("pathAppId", responseData.headers.get("Authorization"));
                console.log(responseData);
                processor(responseData.body);
            }, function (err) {
                if (errorHandler == null) {
                    _this.handleError(err);
                }
                else {
                    errorHandler(err);
                }
            }, function () {
                _this.hideLoading();
                console.log("server POST to " + server + url + " finished:");
                console.log(data);
            });
        }
        else {
            // no url provided, therefore call processor without data
            processor(null);
        }
    };
    PathService.prototype.serverPut = function (server, url, data, processor) {
        var _this = this;
        if (url != null) {
            this.showLoading();
            this.http.put(server + url, data, { observe: "response", headers: this.appendHeaders() })
                .subscribe(function (responseData) {
                sessionStorage.setItem("pathAppId", responseData.headers.get("Authorization"));
                console.log(responseData);
                processor(responseData.body);
            }, function (err) {
                _this.handleError(err);
            }, function () {
                _this.hideLoading();
                console.log("server PUT to " + server + url + " finished:");
                console.log(data);
            });
        }
        else {
            // no url provided, therefore call processor without data
            processor(null);
        }
    };
    PathService.prototype.serverDelete = function (server, url, processor) {
        var _this = this;
        if (url != null) {
            this.showLoading();
            this.http.delete(server + url, { observe: "response", headers: this.appendHeaders() })
                .subscribe(function (data) {
                sessionStorage.setItem("pathAppId", data.headers.get("Authorization"));
                console.log(data);
                processor(data.body);
            }, function (err) {
                _this.handleError(err);
            }, function () {
                _this.hideLoading();
                console.log("server DELETE to " + server + url + " finished:");
            });
        }
        else {
            // no url provided, therefore call processor without data
            processor(null);
        }
    };
    PathService.prototype.handleError = function (err) {
        this.hideLoading();
        if (err.status === 405 && err.error["messageKey"] != null) {
            alert(this.translationService.getText(err.error["messageKey"], err.error["parameters"]));
        }
        else if (err.status === 401) {
            alert("Unauthorized. Please login again.");
            location.reload();
        }
        else {
            // general error
            if (err.error["error"] == null && err.error["title"] == null) {
                this.addAlert("Unkwown Error", "Please check server and internet connection: " + err.error);
            }
            else {
                this.addAlert(err.error["title"], err.error["error"]);
            }
            console.error(err);
        }
    };
    PathService.prototype.appendHeaders = function () {
        var headers = new HttpHeaders();
        headers = headers.append("Content-Type", "application/json");
        var jwt = sessionStorage.getItem("pathAppId");
        if (jwt != null) {
            headers = headers.append("Authorization", jwt);
        }
        return headers;
    };
    PathService.prototype.getAlerts = function () {
        return this._alertStack;
    };
    PathService.prototype.addAlert = function (title, text) {
        var alert = new Alert();
        alert.title = title;
        alert.text = text;
        this._alertStack.push(alert);
    };
    PathService.prototype.clearAlert = function (id) {
        for (var i = 0; i < this._alertStack.length; i++) {
            if (this._alertStack[i].id === id) {
                this._alertStack.splice(i, 1);
                break;
            }
        }
    };
    PathService.ctorParameters = function () { return [
        { type: HttpClient, decorators: [{ type: Inject, args: [HttpClient,] }] },
        { type: TranslationService }
    ]; };
    PathService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(0, Inject(HttpClient))
    ], PathService);
    return PathService;
}());
export { PathService };
var Alert = /** @class */ (function () {
    function Alert() {
        this._id = Date.now();
    }
    Object.defineProperty(Alert.prototype, "title", {
        get: function () {
            return this._title;
        },
        set: function (value) {
            this._title = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Alert.prototype, "text", {
        get: function () {
            return this._text;
        },
        set: function (value) {
            this._text = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Alert.prototype, "id", {
        get: function () {
            return this._id;
        },
        enumerable: true,
        configurable: true
    });
    return Alert;
}());
export { Alert };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vcGF0aC1mcmFtZXdvcmsvIiwic291cmNlcyI6WyJwYXRoLWZyYW1ld29yay9zZXJ2aWNlL3BhdGguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDakQsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFDekQsT0FBTyxFQUFDLFVBQVUsRUFBRSxXQUFXLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUc3RDtJQUtJLHFCQUF3QyxJQUFnQixFQUFVLGtCQUFzQztRQUFoRSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQVUsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUZoRyxnQkFBVyxHQUFZLEVBQUUsQ0FBQztRQUc5QixJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRU0sK0JBQVMsR0FBaEI7UUFDSSxPQUFPLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFTyxpQ0FBVyxHQUFuQjtRQUFBLGlCQUlDO1FBSEcsTUFBTSxDQUFDLFVBQVUsQ0FBQztZQUNkLEtBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN6QixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRU0saUNBQVcsR0FBbEI7UUFBQSxpQkFJQztRQUhHLE1BQU0sQ0FBQyxVQUFVLENBQUM7WUFDZCxLQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDekIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ1YsQ0FBQztJQUVELCtCQUFTLEdBQVQsVUFBVSxNQUFjLEVBQUUsR0FBVyxFQUFFLFNBQTZCLEVBQUUsWUFBK0I7UUFBckcsaUJBZ0NDO1FBL0JHLElBQUksR0FBRyxJQUFJLElBQUksRUFBRTtZQUNiLDJCQUEyQjtZQUMz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QUFELENBQUMsQUF6QkQsSUF5QkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGUsIEluamVjdH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHtUcmFuc2xhdGlvblNlcnZpY2V9IGZyb20gXCIuL3RyYW5zbGF0aW9uLnNlcnZpY2VcIjtcclxuaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwSGVhZGVyc30gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBQYXRoU2VydmljZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBfcmVxdWVzdENvdW50OiBudW1iZXI7XHJcbiAgICBwcml2YXRlIF9hbGVydFN0YWNrOiBBbGVydFtdID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IoQEluamVjdChIdHRwQ2xpZW50KSBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgdHJhbnNsYXRpb25TZXJ2aWNlOiBUcmFuc2xhdGlvblNlcnZpY2UpIHtcclxuICAgICAgICB0aGlzLl9yZXF1ZXN0Q291bnQgPSAwO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpc0xvYWRpbmcoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RDb3VudCA+IDA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzaG93TG9hZGluZygpIHtcclxuICAgICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RDb3VudCsrO1xyXG4gICAgICAgIH0sIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBoaWRlTG9hZGluZygpIHtcclxuICAgICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RDb3VudC0tO1xyXG4gICAgICAgIH0sIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlcnZlckdldChzZXJ2ZXI6IHN0cmluZywgdXJsOiBzdHJpbmcsIHByb2Nlc3NvcjogKGRhdGE6IGFueSkgPT4gYW55LCBlcnJvckhhbmRsZXI6IChlcnI6IGFueSkgPT4gYW55KSB7XHJcbiAgICAgICAgaWYgKHVybCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIC8vIGZldGNoIGpzb24gZGF0YSBmcm9tIHVybFxyXG4gICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgIHRoaXMuaHR0cC5nZXQoc2VydmVyICsgdXJsLCB7b2JzZXJ2ZTogXCJyZXNwb25zZVwiLCBoZWFkZXJzOiB0aGlzLmFwcGVuZEhlYWRlcnMoKX0pXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBqd3QgPSBkYXRhLmhlYWRlcnMuZ2V0KFwiQXV0aG9yaXphdGlvblwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGp3dCAhPSBudWxsICYmIGp3dCAhPT0gXCJcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShcInBhdGhBcHBJZFwiLCBkYXRhLmhlYWRlcnMuZ2V0KFwiQXV0aG9yaXphdGlvblwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKFwicGF0aEFwcElkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NvcihkYXRhLmJvZHkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9ySGFuZGxlciA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvckhhbmRsZXIoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2VydmVyIEdFVCB0byBcIiArIHNlcnZlciArIHVybCArIFwiIGZpbmlzaGVkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gbm8gdXJsIHByb3ZpZGVkLCB0aGVyZWZvcmUgY2FsbCBwcm9jZXNzb3Igd2l0aG91dCBkYXRhXHJcbiAgICAgICAgICAgIHByb2Nlc3NvcihudWxsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHNlcnZlclBvc3Qoc2VydmVyOiBzdHJpbmcsIHVybDogc3RyaW5nLCBkYXRhOiBhbnksIHByb2Nlc3NvcjogKGRhdGE6IGFueSkgPT4gYW55LCBlcnJvckhhbmRsZXI6IChlcnI6IGFueSkgPT4gYW55KSB7XHJcbiAgICAgICAgaWYgKHVybCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcoKTtcclxuICAgICAgICAgICAgdGhpcy5odHRwLnBvc3Qoc2VydmVyICsgdXJsLCBkYXRhLCB7b2JzZXJ2ZTogXCJyZXNwb25zZVwiLCBoZWFkZXJzOiB0aGlzLmFwcGVuZEhlYWRlcnMoKX0pXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlRGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oXCJwYXRoQXBwSWRcIiwgcmVzcG9uc2VEYXRhLmhlYWRlcnMuZ2V0KFwiQXV0aG9yaXphdGlvblwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlRGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NvcihyZXNwb25zZURhdGEuYm9keSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3JIYW5kbGVyID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ySGFuZGxlcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzZXJ2ZXIgUE9TVCB0byBcIiArIHNlcnZlciArIHVybCArIFwiIGZpbmlzaGVkOlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBubyB1cmwgcHJvdmlkZWQsIHRoZXJlZm9yZSBjYWxsIHByb2Nlc3NvciB3aXRob3V0IGRhdGFcclxuICAgICAgICAgICAgcHJvY2Vzc29yKG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZXJ2ZXJQdXQoc2VydmVyOiBzdHJpbmcsIHVybDogc3RyaW5nLCBkYXRhOiBhbnksIHByb2Nlc3NvcjogKGRhdGE6IGFueSkgPT4gYW55KSB7XHJcbiAgICAgICAgaWYgKHVybCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd0xvYWRpbmcoKTtcclxuICAgICAgICAgICAgdGhpcy5odHRwLnB1dChzZXJ2ZXIgKyB1cmwsIGRhdGEsIHtvYnNlcnZlOiBcInJlc3BvbnNlXCIsIGhlYWRlcnM6IHRoaXMuYXBwZW5kSGVhZGVycygpfSlcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VEYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShcInBhdGhBcHBJZFwiLCByZXNwb25zZURhdGEuaGVhZGVycy5nZXQoXCJBdXRob3JpemF0aW9uXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2VEYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc29yKHJlc3BvbnNlRGF0YS5ib2R5KTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInNlcnZlciBQVVQgdG8gXCIgKyBzZXJ2ZXIgKyB1cmwgKyBcIiBmaW5pc2hlZDpcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gbm8gdXJsIHByb3ZpZGVkLCB0aGVyZWZvcmUgY2FsbCBwcm9jZXNzb3Igd2l0aG91dCBkYXRhXHJcbiAgICAgICAgICAgIHByb2Nlc3NvcihudWxsKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2VydmVyRGVsZXRlKHNlcnZlcjogc3RyaW5nLCB1cmw6IHN0cmluZywgcHJvY2Vzc29yOiAoZGF0YTogYW55KSA9PiBhbnkpIHtcclxuICAgICAgICBpZiAodXJsICE9IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZygpO1xyXG4gICAgICAgICAgICB0aGlzLmh0dHAuZGVsZXRlKHNlcnZlciArIHVybCwge29ic2VydmU6IFwicmVzcG9uc2VcIiwgaGVhZGVyczogdGhpcy5hcHBlbmRIZWFkZXJzKCl9KVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgICAgICBkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShcInBhdGhBcHBJZFwiLCBkYXRhLmhlYWRlcnMuZ2V0KFwiQXV0aG9yaXphdGlvblwiKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzb3IoZGF0YS5ib2R5KTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInNlcnZlciBERUxFVEUgdG8gXCIgKyBzZXJ2ZXIgKyB1cmwgKyBcIiBmaW5pc2hlZDpcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBubyB1cmwgcHJvdmlkZWQsIHRoZXJlZm9yZSBjYWxsIHByb2Nlc3NvciB3aXRob3V0IGRhdGFcclxuICAgICAgICAgICAgcHJvY2Vzc29yKG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKGVycikge1xyXG4gICAgICAgIHRoaXMuaGlkZUxvYWRpbmcoKTtcclxuICAgICAgICBpZiAoZXJyLnN0YXR1cyA9PT0gNDA1ICYmIGVyci5lcnJvcltcIm1lc3NhZ2VLZXlcIl0gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICBhbGVydCh0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5nZXRUZXh0KGVyci5lcnJvcltcIm1lc3NhZ2VLZXlcIl0sIGVyci5lcnJvcltcInBhcmFtZXRlcnNcIl0pKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGVyci5zdGF0dXMgPT09IDQwMSkge1xyXG4gICAgICAgICAgICBhbGVydChcIlVuYXV0aG9yaXplZC4gUGxlYXNlIGxvZ2luIGFnYWluLlwiKTtcclxuICAgICAgICAgICAgbG9jYXRpb24ucmVsb2FkKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gZ2VuZXJhbCBlcnJvclxyXG4gICAgICAgICAgICBpZiAoZXJyLmVycm9yW1wiZXJyb3JcIl0gPT0gbnVsbCAmJiBlcnIuZXJyb3JbXCJ0aXRsZVwiXSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZEFsZXJ0KFwiVW5rd293biBFcnJvclwiLCBcIlBsZWFzZSBjaGVjayBzZXJ2ZXIgYW5kIGludGVybmV0IGNvbm5lY3Rpb246IFwiICsgZXJyLmVycm9yKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYWRkQWxlcnQoZXJyLmVycm9yW1widGl0bGVcIl0sIGVyci5lcnJvcltcImVycm9yXCJdKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXBwZW5kSGVhZGVycygpOiBIdHRwSGVhZGVycyB7XHJcbiAgICAgICAgbGV0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcclxuICAgICAgICBoZWFkZXJzID0gaGVhZGVycy5hcHBlbmQoXCJDb250ZW50LVR5cGVcIiwgXCJhcHBsaWNhdGlvbi9qc29uXCIpO1xyXG4gICAgICAgIGNvbnN0IGp3dDogc3RyaW5nID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcInBhdGhBcHBJZFwiKTtcclxuICAgICAgICBpZiAoand0ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgaGVhZGVycyA9IGhlYWRlcnMuYXBwZW5kKFwiQXV0aG9yaXphdGlvblwiLCBqd3QpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaGVhZGVycztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QWxlcnRzKCk6IEFsZXJ0W10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9hbGVydFN0YWNrO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRBbGVydCh0aXRsZTogc3RyaW5nLCB0ZXh0OiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBhbGVydCA9IG5ldyBBbGVydCgpO1xyXG4gICAgICAgIGFsZXJ0LnRpdGxlID0gdGl0bGU7XHJcbiAgICAgICAgYWxlcnQudGV4dCA9IHRleHQ7XHJcbiAgICAgICAgdGhpcy5fYWxlcnRTdGFjay5wdXNoKGFsZXJ0KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xlYXJBbGVydChpZDogbnVtYmVyKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9hbGVydFN0YWNrLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9hbGVydFN0YWNrW2ldLmlkID09PSBpZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fYWxlcnRTdGFjay5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBBbGVydCB7XHJcblxyXG4gICAgcHJpdmF0ZSBfdGl0bGU6IHN0cmluZztcclxuICAgIHByaXZhdGUgX3RleHQ6IHN0cmluZztcclxuICAgIHByaXZhdGUgX2lkOiBudW1iZXIgPSBEYXRlLm5vdygpO1xyXG5cclxuICAgIGdldCB0aXRsZSgpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl90aXRsZTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgdGl0bGUodmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX3RpdGxlID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHRleHQoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fdGV4dDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgdGV4dCh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fdGV4dCA9IHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpZCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9pZDtcclxuICAgIH1cclxufVxyXG4iXX0=